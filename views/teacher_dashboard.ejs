<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title><%= titre %> - Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯ | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>




    .custom-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 0 0 10px 10px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 999;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .search-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
    }
    .search-item:hover {
        background: #f8f9fa;
        color: var(--primary);
    }
    .search-item span {
        font-size: 0.8rem;
        color: #777;
    }

        :root {
            --primary: #1e3a8a;
            --primary-gradient: linear-gradient(135deg, #1e3a8a, #3b82f6);
            --accent: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --radius-xl: 24px;
            --radius-lg: 16px;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; scroll-behavior: smooth; }
        body { background-color: var(--bg); color: #1e293b; line-height: 1.6; padding-bottom: 90px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; display: flex; flex-direction: column; gap: 20px; }
        .hidden { display: none !important; }

        .period-card.sub-active {
            background-color: #fef9c3 !important; 
            border: 2px solid #facc15 !important; 
        }
        .sub-tag {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            background: #eab308; color: white; font-size: 0.55rem; padding: 2px 8px;
            border-radius: 20px; font-weight: 900; white-space: nowrap;
        }

        .main-header {
            background: var(--primary-gradient); color: white; padding: 20px; border-radius: 0 0 var(--radius-xl) var(--radius-xl);
            display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow);
            position: sticky; top: 0; z-index: 1000;
        }
        .header-user h1 { font-size: 1.1rem; font-weight: 900; }
        .btn-logout { background: rgba(255,255,255,0.2); color: white; text-decoration: none; padding: 5px 12px; border-radius: 10px; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.3); display: inline-block; margin-top: 5px; }

        .live-clock-box { text-align: left; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 12px; }
        #live-clock { font-size: 1.2rem; font-weight: 900; display: block; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            display: flex; justify-content: space-around; padding: 12px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); border-top: 1px solid #edf2f7; z-index: 1000;
        }
        .nav-item { text-decoration: none; color: #94a3b8; text-align: center; font-size: 0.7rem; font-weight: 600; }
        .nav-item i { font-size: 1.3rem; display: block; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }

        .substitution-alert {
            background: #fff3cd; border-right: 6px solid var(--warning);
            padding: 15px; border-radius: var(--radius-lg); display: flex; 
            flex-direction: column; gap: 10px; box-shadow: var(--shadow); animation: slideDown 0.5s ease-out;
        }
        .sub-info { display: flex; align-items: center; gap: 10px; }
        .sub-info i { font-size: 1.5rem; color: var(--warning); animation: pulse-icon 1.5s infinite; }
        .btn-accept { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; }

        .admin-notif-bar {
            background: #e0f2fe; border-right: 6px solid var(--primary);
            padding: 15px; border-radius: 15px; display: flex; align-items: center; gap: 12px; animation: slideDown 0.5s ease;
        }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: var(--card-bg); padding: 15px; border-radius: var(--radius-lg); box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; border-bottom: 4px solid var(--primary); }
        .stat-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: #eff6ff; color: var(--primary); }

        .banner-container { background: #e2e8f0; padding: 20px 10px; border-radius: 25px; overflow: hidden; }
        .banner-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .banner-scroll::-webkit-scrollbar { display: none; }
        .period-card { min-width: 140px; background: white; border-radius: 18px; padding: 15px 10px; text-align: center; flex-shrink: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative;}
        .period-card.active-now { border: 2px solid var(--accent); background: #fff1f2; transform: scale(1.02); animation: pulse-border 2s infinite; }
        
        .panel { background: var(--card-bg); border-radius: var(--radius-xl); padding: 20px; box-shadow: var(--shadow); }
        .student-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px; }
        .student-card { background: #f1f5f9; padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0; }

        .todo-section { background: var(--card-bg); padding: 20px; border-radius: var(--radius-xl); box-shadow: var(--shadow); }
        .btn-submit { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 15px; font-weight: 700; cursor: pointer; }
        
        .switch { position: relative; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background: #cbd5e1; border-radius: 34px; transition: 0.4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.4s; }
        input:checked + .slider { background: var(--accent); }
        input:checked + .slider:before { transform: translateX(22px); }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-icon { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body id="top">

<header class="main-header">
    <div class="header-user">
        <h1>Ø£Ù‡Ù„Ø§Ù‹ Ø£/ <%= prof.nom %></h1>
        <div style="background: rgba(255, 215, 0, 0.2); color: #ffd700; padding: 4px 10px; border-radius: 8px; display: inline-flex; align-items: center; gap: 6px; margin-top: 5px; border: 1px solid rgba(255, 215, 0, 0.3); font-size: 0.85rem; font-weight: 700;">
            <i class="fas fa-star"></i>
            <span><%= prof.stars_count || 0 %> Ù†Ø¬Ù…Ø©</span>
        </div>
        <br>
        <a href="/logout" class="btn-logout"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
    </div>
    <div class="live-clock-box">
        <span id="live-clock">00:00:00</span>
        <small id="current-status-text" style="font-size: 0.6rem; opacity: 0.8;">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø¬Ø¯ÙˆÙ„...</small>
    </div>
</header>

<% if (typeof evaluation_requests !== 'undefined' && evaluation_requests.length > 0) { %>
    <div id="eval-requests-container" style="margin-bottom: 20px; padding: 0 15px;">
        <% evaluation_requests.forEach(req => { %>
            <div class="admin-notif-bar" style="background: #fdf2f8; border-right: 6px solid #db2777;">
                <i class="fas fa-star" style="color: #db2777;"></i>
                <div style="flex:1; font-size: 0.85rem;">
                    <div style="font-weight: 800; color: #9d174d;">Ø·Ù„Ø¨ ØªÙ‚ÙŠÙŠÙ… Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</div>
                    <div style="color: #4b5563;">
                        ÙŠØ±Ø¬Ù‰ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ø§Ù„Ø¨: <strong><%= req.student_name %></strong> 
                        <span style="background: #fae8f0; padding: 2px 8px; border-radius: 4px;"><%= req.classe %></span>
                    </div>
                </div>
                <a href="/teacher/evaluate/<%= req.id %>/<%= req.eleve_id %>" style="background: #db2777; color: white; padding: 8px 15px; border-radius: 8px; text-decoration: none; font-size: 0.8rem;">ØªÙ‚ÙŠÙŠÙ…</a>
            </div>
        <% }) %>
    </div>
<% } %>

<div class="container">
    
    <% if (typeof substitute_logs !== 'undefined' && substitute_logs.length > 0) { %>
        <div id="sub-requests-container">
            <% substitute_logs.filter(s => s.status === 'pending').forEach(sub => { %>
                <div class="substitution-alert">
                    <div class="sub-info">
                        <i class="fas fa-clock-rotate-left"></i>
                        <div>
                            <h4 style="color: #856404; font-size: 0.9rem;">ØªÙˆØ²ÙŠØ¹ Ø­ØµØ© Ø§Ø­ØªÙŠØ§Ø·</h4>
                            <p style="font-size: 0.8rem;">Ø§Ù„Ø­ØµØ©: <%= sub.periode %> | Ø§Ù„ÙØµÙ„: <%= sub.classe %>-<%= sub.section %></p>
                        </div>
                    </div>
                   <form action="/teacher/substitute/respond" method="POST">
    <input type="hidden" name="sub_id" value="<%= sub.id %>">
    <input type="hidden" name="action" value="accept">
    <input type="hidden" name="teacher_id" value="<%= prof.id %>"> 
    
    <button type="submit" class="btn-accept" style="background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
        <i class="fas fa-check"></i> Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø­ØµØ©
    </button>
</form>
                </div>
            <% }) %>
        </div>
    <% } %>

    <% if (typeof announcements !== 'undefined' && announcements.length > 0) { %>
        <div id="admin-announcements-container">
            <% announcements.forEach(ann => { %>
                <div class="admin-notif-bar" id="ann-box-<%= ann.id %>">
                    <i class="fas fa-bullhorn"></i>
                    <div style="flex:1; font-size: 0.85rem;">
                        <div style="font-weight: 800; color: var(--primary);"><%= ann.title %></div>
                        <div><%= ann.content %></div>
                        <small style="opacity: 0.6;"><%= ann.date %></small>
                    </div>
                    <button onclick="dismissNotification('<%= ann.id %>', '<%= prof.id %>')" style="background:none; border:none; color:var(--accent);"><i class="fas fa-times"></i></button>
                </div>
            <% }) %>
        </div>
    <% } %>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-tasks"></i></div>
            <div><h3 id="todo-count">0</h3><p style="font-size: 0.7rem;">Ù…Ù‡Ø§Ù…</p></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--success);"><i class="fas fa-check-double"></i></div>
            <div><h3 id="marked-sessions">0</h3><p style="font-size: 0.7rem;">Ø­ØµØµ Ù…Ø±ØµÙˆØ¯Ø©</p></div>
        </div>
        <div class="stat-card" style="grid-column: span 2; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; border-bottom: 4px solid #ffd700;">
            <div class="stat-icon" style="background: rgba(255,215,0,0.1); color: #ffd700;"><i class="fas fa-trophy"></i></div>
            <div style="flex: 1; display: flex; justify-content: space-between; align-items: center;">
                <div><h3 style="color: #ffd700;"><%= prof.stars_count || 0 %> <i class="fas fa-star" style="font-size: 0.9rem;"></i></h3><p style="font-size: 0.75rem;">Ø±ØµÙŠØ¯ Ø§Ù„ØªÙ…ÙŠØ²</p></div>
                <span style="font-size: 0.7rem; padding: 4px 12px; border-radius: 20px; background: rgba(255,255,255,0.1); color:#ffd700; border:1px solid #ffd700;">
                    <%= (prof.stars_count || 0) >= 100 ? 'Ù…Ø¹Ù„Ù… Ù‚Ø¯ÙŠØ±' : ((prof.stars_count || 0) >= 50 ? 'Ù…Ø¹Ù„Ù… Ù…ØªÙ…ÙŠØ²' : 'Ù…Ø¹Ù„Ù… Ù…Ø¨Ø§Ø¯Ø±') %>
                </span>
            </div>
        </div>
    </div>

    <section id="section-schedule">
    <h3 style="margin-bottom: 10px; color: var(--primary); font-size: 1rem;">
        <i class="fas fa-calendar-day"></i> 
        Ø¬Ø¯ÙˆÙ„ Ø­ØµØµ ÙŠÙˆÙ…: <span id="current-day-name" style="color: var(--accent);"></span>
    </h3>
    <div class="banner-container">
        <div class="banner-scroll" id="banner-scroll">
            <% for(let i=1; i<=8; i++) { 
                let p = school_periods.find(x => x.id === i);
                
                // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­ØµØ© Ø§Ù„ØªÙŠ ØªØ·Ø§Ø¨Ù‚ Ø±Ù‚Ù… Ø§Ù„Ø­ØµØ© "Ùˆ" Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
                // Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ¹Ø±ÙŠÙ currentDayLocale ÙÙŠ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ø§Ù„Ø£Ø³ÙÙ„
            %>
                <div class="period-card" id="period-<%= i %>">
                    <span style="font-size: 0.7rem; font-weight: bold; color: #64748b;">Ø§Ù„Ø­ØµØ© <%= i %></span>
                    <div id="session-content-<%= i %>" style="font-size: 1.1rem; font-weight: 900; color: var(--primary); margin: 8px 0;">
                        <span style="opacity: 0.2;">--</span>
                    </div>
                    <span style="font-size: 0.7rem; color: #94a3b8;"><%= p ? p.start_time : '--:--' %></span>
                </div>
            <% } %>
        </div>
    </div>
</section>

    <section id="section-attendance" class="panel">
        <div id="no-session-msg" class="hidden" style="text-align: center; color: #94a3b8; padding: 30px;">
            <i class="fas fa-hourglass-start" style="font-size: 2.5rem; margin-bottom: 10px; opacity: 0.3;"></i>
            <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØ© Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
        </div>
        <div id="attendance-active" class="hidden">
            <div style="background: #eff6ff; padding: 12px; border-radius: 12px; border-right: 5px solid var(--primary); margin-bottom: 15px; font-size: 0.9rem;">
                <strong> Ø±ØµØ¯ ØºÙŠØ§Ø¨ ÙØµÙ„: </strong> <span id="active-class-title">--</span>
            </div>
            <form action="/teacher/absences/mark" method="POST">
                <input type="hidden" name="enseignant_id" value="<%= prof.id %>">
                <input type="hidden" name="date" id="input-date">
                <input type="hidden" name="periode" id="input-p">
                <div class="student-grid" id="student-grid-container"></div>
                <button type="submit" class="btn-submit">ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨</button>
            </form>
        </div>
    </section>

    <section id="section-todo" class="todo-section">
        <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 1rem;"><i class="fas fa-list-check"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h3>
        <div style="display: flex; gap: 8px; margin-bottom: 15px;">
            <input type="text" id="todo-input" style="padding: 12px; flex:1; border:1px solid #e2e8f0; border-radius:12px;" placeholder="Ø£Ø¶Ù Ù…Ù‡Ù…Ø©...">
            <button onclick="addTodo()" style="background:var(--primary); color:white; border:none; padding:0 15px; border-radius:12px;">+</button>
        </div>
        <ul id="todo-list" style="list-style: none; font-size: 0.9rem;"></ul>
    </section>

    <section id="section-behavior" class="panel">
    <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 1rem;"><i class="fas fa-user-shield"></i> Ù…Ù„Ø§Ø­Ø¸Ø© Ø³Ù„ÙˆÙƒÙŠØ© Ø°ÙƒÙŠØ©</h3>
    
    <div style="display: flex; flex-direction: column; gap: 10px;">
        <div style="position: relative;">
            <input type="text" id="studentSearchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." 
                   style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--primary); font-family: 'Cairo'; outline: none;">
            
            <div id="searchResultsList" class="custom-search-results"></div>
        </div>

        <form action="/teacher/behavior/add" method="POST" id="behaviorForm">
            <input type="hidden" name="teacher_id" value="<%= prof.id %>">
            <input type="hidden" name="student_id" id="hiddenStudentId" required>
            
            <div id="selectedStudentBadge" style="display: none; margin-bottom: 10px; padding: 5px 10px; background: #e3f2fd; border-radius: 5px; color: #1976d2; font-size: 0.9rem;">
                ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: <span id="selectedStudentName" style="font-weight: bold;"></span>
                <i class="fas fa-times" style="margin-right: 10px; cursor: pointer; color: red;" onclick="clearStudentSelection()"></i>
            </div>

            <textarea name="event" placeholder="ØµÙ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø£Ùˆ Ø§Ù„Ø­Ø§Ø¯Ø«Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„..." required 
                      style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; height: 80px; font-family: 'Cairo'; margin-top: 5px;"></textarea>
            
            <button type="submit" class="btn-submit" style="width: 100%; padding: 12px; margin-top: 10px;">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </form>
    </div>
</section>
</div>

<nav class="bottom-nav">
    <a href="#top" class="nav-item active"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="#section-schedule" class="nav-item"><i class="fas fa-calendar-alt"></i>Ø§Ù„Ø¬Ø¯ÙˆÙ„</a>
    <a href="#section-attendance" class="nav-item"><i class="fas fa-user-check"></i>Ø§Ù„ØºÙŠØ§Ø¨</a>
    <a href="#section-todo" class="nav-item"><i class="fas fa-tasks"></i>Ø§Ù„Ù…Ù‡Ø§Ù…</a>
</nav>

<script>
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    const TIMETABLE = <%- JSON.stringify(timetable) %>;
    const PERIODS = <%- JSON.stringify(school_periods) %>;
    const ELEVES = <%- JSON.stringify(eleves) %>;
    const SUBSTITUTIONS = <%- JSON.stringify(substitute_logs || []) %>;
    // Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù…Ø§ ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    const dayNamesAr = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];

    function updateApp() {
    const now = new Date();
    const currentDayIndex = now.getDay(); 
    const currentDayNameAr = dayNamesAr[currentDayIndex];
    
    // 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ù†ÙØ³ ØµÙŠØºØ© Ø§Ù„Ø³ÙŠØ±ÙØ± (YYYY-MM-DD)
    const todayStr = now.toISOString().split('T')[0];

    const dayDisplay = document.getElementById('current-day-name');
    if(dayDisplay) dayDisplay.textContent = currentDayNameAr;

    document.getElementById('live-clock').textContent = now.toLocaleTimeString('ar-EG', {hour12:false});
    document.getElementById('input-date').value = todayStr;

    const mins = now.getHours() * 60 + now.getMinutes();
    let activeP = null;

    PERIODS.forEach(p => {
        const card = document.getElementById(`period-${p.id}`);
        const sessionContent = document.getElementById(`session-content-${p.id}`); 
        
        // 2. Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø­ØªÙŠØ§Ø· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… (Ø±Ù‚Ù… Ø§Ù„Ø­ØµØ© + Ø§Ù„Ø­Ø§Ù„Ø© + ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…)
        const sub = SUBSTITUTIONS.find(x => {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø­ØµØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø© (Ù„Ø£Ù†Ù‡Ø§ Ù‚Ø¯ ØªØ£ØªÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨ØµÙŠØºØ© ISO ÙƒØ§Ù…Ù„Ø©)
            const subDate = new Date(x.date).toISOString().split('T')[0];
            return x.periode === p.id && x.status === 'accepted' && subDate === todayStr;
        });

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
        const normal = TIMETABLE.find(x => x.periode === p.id && x.jour === currentDayNameAr);

        if (sub) {
            sessionContent.innerHTML = `<span class="sub-tag">Ø§Ø­ØªÙŠØ§Ø·</span> ${sub.classe}-${sub.section}`;
            card.classList.add('sub-active');
            sessionContent.style.opacity = "1";
        } else if (normal) {
            sessionContent.innerHTML = `${normal.classe}-${normal.section}`;
            card.classList.remove('sub-active');
            sessionContent.style.opacity = "1";
        } else {
            sessionContent.innerHTML = "Ø§Ø³ØªØ±Ø§Ø­Ø©";
            card.classList.remove('sub-active');
            sessionContent.style.opacity = "0.3";
        }

        const [hS, mS] = p.start_time.split(':').map(Number);
        const [hE, mE] = p.end_time.split(':').map(Number);
        if (mins >= (hS*60+mS) && mins <= (hE*60+mE)) {
            card.classList.add('active-now'); 
            activeP = p;
        } else {
            card.classList.remove('active-now');
        }
    });

    manageAttendanceUI(activeP, currentDayNameAr, todayStr); // Ù…Ø±Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹
}  
function manageAttendanceUI(p, currentDayName) {
    const noMsg = document.getElementById('no-session-msg');
    const activeArea = document.getElementById('attendance-active');
    const statusText = document.getElementById('current-status-text');

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†ÙØ³ ØµÙŠØºØ© Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
    const todayStr = new Date().toISOString().split('T')[0];

    if (!p) {
        noMsg.classList.remove('hidden'); 
        activeArea.classList.add('hidden');
        statusText.textContent = "Ø®Ø§Ø±Ø¬ ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ù„"; 
        return;
    }

    // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø­ØªÙŠØ§Ø· Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®
    const sub = SUBSTITUTIONS.find(x => {
        const subDate = new Date(x.date).toISOString().split('T')[0];
        return x.periode === p.id && x.status === 'accepted' && subDate === todayStr;
    });

    const normal = TIMETABLE.find(s => s.periode === p.id && s.jour === currentDayName);
    const session = sub || normal;

    if (!session) {
        noMsg.classList.remove('hidden'); 
        activeArea.classList.add('hidden');
        statusText.textContent = "Ø§Ø³ØªØ±Ø§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹";
    } else {
        noMsg.classList.add('hidden'); 
        activeArea.classList.remove('hidden');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ù„ÙŠØ¹Ø±Ù Ø§Ù„Ù…Ø¹Ù„Ù… Ù†ÙˆØ¹ Ø§Ù„Ø­ØµØ©
        statusText.textContent = sub ? `Ø­ØµØ© Ø§Ø­ØªÙŠØ§Ø· Ø¬Ø§Ø±ÙŠØ© (Ø¨Ø¯Ù„ ØºØ§Ø¦Ø¨)` : `Ø­ØµØ© Ø±Ù‚Ù… ${p.id} Ø¬Ø§Ø±ÙŠØ©`;
        
        document.getElementById('active-class-title').textContent = `${session.classe}-${session.section}`;
        document.getElementById('input-p').value = p.id;
        
        // Ø±ØµØ¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„ÙØµÙ„ Ø§Ù„ØµØ­ÙŠØ­
        renderStudents(session.classe, session.section);
    }
}
    function renderStudents(classe, section) {
        const container = document.getElementById('student-grid-container');
        if (container.dataset.currentClass === `${classe}-${section}`) return;
        
        container.innerHTML = ""; 
        container.dataset.currentClass = `${classe}-${section}`;
        
        const list = ELEVES.filter(e => e.classe == classe && e.section == section);
        list.forEach(el => {
            container.innerHTML += `
                <div class="student-card">
                    <span>${el.nom}</span>
                    <label class="switch">
                        <input type="checkbox" name="eleve_ids[]" value="${el.id}">
                        <span class="slider"></span>
                    </label>
                </div>`;
        });
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‡Ø§Ù… (To-Do List) ---
    let todos = JSON.parse(localStorage.getItem('teacher_todos')) || [];
    function saveTodos() { localStorage.setItem('teacher_todos', JSON.stringify(todos)); displayTodos(); }
    function addTodo() {
        const input = document.getElementById('todo-input');
        if (!input.value.trim()) return;
        todos.push({ id: Date.now(), text: input.value, completed: false });
        input.value = ""; saveTodos();
    }
    function toggleTodo(id) { todos = todos.map(t => t.id === id ? {...t, completed: !t.completed} : t); saveTodos(); }
    function deleteTodo(id) { todos = todos.filter(t => t.id !== id); saveTodos(); }
    function displayTodos() {
        const list = document.getElementById('todo-list');
        list.innerHTML = "";
        let count = 0;
        todos.forEach(t => {
            if(!t.completed) count++;
            list.innerHTML += `
                <li style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                    <span onclick="toggleTodo(${t.id})" style="cursor:pointer; ${t.completed ? 'text-decoration:line-through; opacity:0.5' : ''}">${t.text}</span>
                    <i class="fas fa-trash" onclick="deleteTodo(${t.id})" style="color:var(--accent); cursor:pointer;"></i>
                </li>`;
        });
        document.getElementById('todo-count').textContent = count;
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ---
    function dismissNotification(annId, profId) {
        const element = document.getElementById('ann-box-' + annId);
        if (element) element.remove();
        const storageKey = 'dismissed_ann_prof_' + profId;
        let dismissed = JSON.parse(localStorage.getItem(storageKey) || '[]');
        if (!dismissed.includes(annId)) { dismissed.push(annId); localStorage.setItem(storageKey, JSON.stringify(dismissed)); }
    }

    function applyHiddenAnnouncements() {
        const profId = '<%= prof.id %>';
        const storageKey = 'dismissed_ann_prof_' + profId;
        const hidden = JSON.parse(localStorage.getItem(storageKey) || '[]');
        hidden.forEach(id => { const el = document.getElementById('ann-box-' + id); if (el) el.remove(); });
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ø³Ø§Ø¹Ø© ÙˆØ§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø­ØµØµ
    setInterval(updateApp, 1000);
    window.onload = () => { 
        updateApp(); 
        displayTodos(); 
        applyHiddenAnnouncements(); 
    };
</script>
<script>
    // ØªØ­ÙˆÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† EJS Ø¥Ù„Ù‰ JavaScript
    const studentsData = <%- JSON.stringify(eleves) %>;
    
    const searchInput = document.getElementById('studentSearchInput');
    const resultsList = document.getElementById('searchResultsList');
    const hiddenIdInput = document.getElementById('hiddenStudentId');
    const badge = document.getElementById('selectedStudentBadge');
    const badgeName = document.getElementById('selectedStudentName');

    searchInput.addEventListener('input', function() {
        const term = this.value.trim().toLowerCase();
        resultsList.innerHTML = '';
        
        if (term.length < 2) {
            resultsList.style.display = 'none';
            return;
        }

        const matches = studentsData.filter(s => s.nom.toLowerCase().includes(term));

        if (matches.length > 0) {
            matches.forEach(s => {
                const item = document.createElement('div');
                item.className = 'search-item';
                item.innerHTML = `<strong>${s.nom}</strong> <br> <span>Ø§Ù„ØµÙ: ${s.classe} - ${s.section}</span>`;
                item.onclick = function() {
                    selectStudent(s.id, s.nom);
                };
                resultsList.appendChild(item);
            });
            resultsList.style.display = 'block';
        } else {
            resultsList.style.display = 'none';
        }
    });

    function selectStudent(id, name) {
        hiddenIdInput.value = id;
        badgeName.innerText = name;
        badge.style.display = 'block';
        searchInput.value = ''; // Ù…Ø³Ø­ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø«
        resultsList.style.display = 'none';
    }

    function clearStudentSelection() {
        hiddenIdInput.value = '';
        badge.style.display = 'none';
        searchInput.value = '';
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', function(e) {
        if (e.target !== searchInput) resultsList.style.display = 'none';
    });
</script>
</body>
</html>