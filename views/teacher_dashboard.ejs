<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title><%= titre %> - Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯ | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1e3a8a;
            --primary-gradient: linear-gradient(135deg, #1e3a8a, #3b82f6);
            --accent: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --radius-xl: 24px;
            --radius-lg: 16px;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; scroll-behavior: smooth; }
        body { background-color: var(--bg); color: #1e293b; line-height: 1.6; padding-bottom: 90px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; display: flex; flex-direction: column; gap: 20px; }
        .hidden { display: none !important; }

        .main-header {
            background: linear-gradient(135deg, #00843D 0%, #D21034 50%, #FFFFFF 100%);
            background-size: 200% 200%;
            animation: gradientAnimation 10s ease infinite;
            color: rgb(254, 254, 254); padding: 20px 30px; border-radius: 0 0 20px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 1000;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header-user h1 { font-size: 1.5rem; margin: 0; text-shadow: 1px 1px 4px rgba(0,0,0,0.3); }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„Ø¬Ø±Ø³ */
@keyframes bell-shake {
    0%, 100% { transform: rotate(0); }
    20% { transform: rotate(15deg); }
    40% { transform: rotate(-15deg); }
    60% { transform: rotate(10deg); }
    80% { transform: rotate(-10deg); }
}

.bell-urgent {
    animation: bell-shake 0.5s ease infinite;
    color: #ffd700 !important; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø°Ù‡Ø¨ÙŠ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙÙˆÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¹Ù…Ø§Ù†ÙŠØ© */
    filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
}

#urgent-dot {
    display: none;
    position: absolute;
    top: -2px;
    right: -2px;
    width: 10px;
    height: 10px;
    background: white;
    border: 2px solid #D21034; /* Ø­Ø¯ÙˆØ¯ Ø­Ù…Ø±Ø§Ø¡ Ø¹ÙÙ…Ø§Ù†ÙŠØ© */
    border-radius: 50%;
}
        
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            display: flex; justify-content: space-around; padding: 12px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); border-top: 1px solid #edf2f7; z-index: 1000;
        }
        .nav-item { text-decoration: none; color: #94a3b8; text-align: center; font-size: 0.7rem; font-weight: 600; }
        .nav-item i { font-size: 1.3rem; display: block; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: var(--card-bg); padding: 15px; border-radius: var(--radius-lg); box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; border-bottom: 4px solid var(--primary); }
        .stat-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: #eff6ff; color: var(--primary); }

        .banner-container { background: #e2e8f0; padding: 20px 10px; border-radius: 25px; overflow: hidden; }
        .banner-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .banner-scroll::-webkit-scrollbar { display: none; }
        .period-card { min-width: 140px; background: white; border-radius: 18px; padding: 15px 10px; text-align: center; flex-shrink: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; }
        .period-card.active-now { border: 2px solid var(--accent); background: #fff1f2; transform: scale(1.02); animation: pulse-border 2s infinite; }
        .period-card.is-done { border-right: 5px solid #4caf50 !important; position: relative; }
        .period-card.is-done::after { content: 'âœ…'; position: absolute; top: 5px; left: 5px; font-size: 0.8rem; }

        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .sub-tag { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #eab308; color: white; font-size: 0.55rem; padding: 2px 8px; border-radius: 20px; font-weight: 900; }

        .panel { background: var(--card-bg); border-radius: var(--radius-xl); padding: 20px; box-shadow: var(--shadow); }
        #student-grid-container { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .student-card { background: #f1f5f9; padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0; }

        .lock-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(145deg, #ffffff, #f1f8e9);
            border-radius: 20px;
            border: 2px solid #a5d6a7;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        .lock-message i { font-size: 3rem; color: #2e7d32; background: #c8e6c9; width: 80px; height: 80px; line-height: 80px; border-radius: 50%; margin-bottom: 15px; }

        .custom-search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .search-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; }
        .search-item:hover { background: #f8f9fa; color: var(--primary); }

        .switch { position: relative; width: 44px; height: 22px; }
        .switch input { opacity: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background: #cbd5e1; border-radius: 34px; transition: 0.4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.4s; }
        input:checked + .slider { background: var(--accent); }
        input:checked + .slider:before { transform: translateX(22px); }

        .btn-submit { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 15px; font-weight: 700; cursor: pointer; }

        /* ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø­Ø³Ø§Ø¨ */
        .secure-open { max-height: 250px !important; padding-bottom: 20px !important; }
        .rotate-chevron { transform: rotate(180deg); }
        .form-row { display: flex; gap: 8px; align-items: center; }
        .input-wrapper { position: relative; flex: 1; }
        .input-icon { position: absolute; right: 12px; color: #94a3b8; z-index: 5; }
        .custom-input { width: 100%; padding: 12px 40px; border: 2px solid #f1f5f9; border-radius: 12px; background: #f8fafc; transition: 0.3s; }
        .custom-input:focus { border-color: var(--primary); background: #fff; }
        .toggle-view-btn { position: absolute; left: 10px; background: none; border: none; color: #94a3b8; cursor: pointer; }
        .submit-action-btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .strength-meter { height: 4px; width: 0; background: #e2e8f0; margin-top: 8px; border-radius: 2px; transition: 0.3s; }
    </style>
</head>
<body>

<header class="main-header">
    <div class="header-user">
        <h1>Ø£Ù‡Ù„Ø§Ù‹ Ø£/ <%= prof.nom %></h1>
        <div style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 50px; display: inline-flex; align-items: center; gap: 8px; margin-top: 8px;">
            <i class="fas fa-star" style="color: #ffd700;"></i>
            <span style="font-weight: 700;"><%= prof.stars_count || 0 %> Ù†Ø¬Ù…Ø©</span>
        </div>
    </div>
    <div style="display: flex; align-items: center; gap: 25px;">
        <div class="notification-bell" onclick="document.getElementById('ann-container').scrollIntoView({behavior: 'smooth'})">
            <i class="fas fa-bell" id="sidebar-bell" style="font-size: 1.8rem; transition: 0.3s;"></i>
            <span id="urgent-dot"></span>
        </div>
        <a href="/logout" style="color: white; background: rgba(0,0,0,0.2); padding: 8px 15px; border-radius: 10px; display: flex; align-items: center; gap: 8px; text-decoration: none;">
            <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
        </a>
    </div>
</header>

<div class="container">

    <% if (evaluation_requests && evaluation_requests.length > 0) { %>
        <div style="margin: 0 15px 20px;">
            <% evaluation_requests.forEach(req => { %>
                <div class="admin-notif-bar" style="background: #fdf2f8; border-right: 6px solid #db2777; padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; align-items: center;">
                    <i class="fas fa-star" style="color: #db2777; font-size: 1.2rem; margin-left: 15px;"></i>
                    <div style="flex:1;">
                        <div style="font-weight: 800; color: #9d174d;">Ø·Ù„Ø¨ ØªÙ‚ÙŠÙŠÙ… Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</div>
                        <div>Ø§Ù„Ø·Ø§Ù„Ø¨: <strong><%= req.student_name %></strong> - <%= req.classe %></div>
                    </div>
                    <a href="/teacher/evaluate/<%= req.id %>/<%= req.eleve_id %>" style="background: #db2777; color: white; padding: 8px 15px; border-radius: 8px; text-decoration: none;">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¢Ù†</a>
                </div>
            <% }) %>
        </div>
    <% } %>

    <% if (substitute_logs && substitute_logs.some(s => s.status === 'pending')) { %>
        <div style="margin: 0 15px 20px;">
            <% substitute_logs.filter(s => s.status === 'pending').forEach(sub => { %>
                <div class="substitution-alert" style="background: #fffbeb; border-right: 6px solid #f59e0b; padding: 15px; border-radius: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-clock" style="color: #f59e0b; font-size: 1.5rem;"></i>
                        <div>
                            <strong>Ø­ØµØ© Ø§Ø­ØªÙŠØ§Ø·</strong><br>
                            Ø§Ù„Ø­ØµØ© <%= sub.periode %> | Ø§Ù„ÙØµÙ„ <%= sub.classe %>-<%= sub.section %>
                        </div>
                    </div>
                    <form action="/teacher/substitute/respond" method="POST" style="margin-top: 10px;">
                        <input type="hidden" name="sub_id" value="<%= sub.id %>">
                        <input type="hidden" name="action" value="accept">
                        <input type="hidden" name="teacher_id" value="<%= prof.id %>">
                        <button type="submit" style="background: #22c55e; color: white; border: none; padding: 8px 15px; border-radius: 8px;">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø­ØµØ©</button>
                    </form>
                </div>
            <% }) %>
        </div>
    <% } %>

    <div class="announcements-list" id="ann-container">
        <% announcements.forEach(ann => { %>
            <% let cardStyle = ann.priority === 'urgent' ? 'border-right: 5px solid #ef4444; background: #fef2f2;' : ann.priority === 'high' ? 'border-right: 5px solid #f59e0b; background: #fffbeb;' : 'border-right: 5px solid #3b82f6; background: #f0f9ff;'; %>
            <div class="announcement-card" id="teacher-ann-<%= ann.id %>" style="<%= cardStyle %> padding: 20px; margin-bottom: 15px; border-radius: 12px; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="display: flex; justify-content: space-between;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 10px 0; color: #1e293b;"><%= ann.title %></h4>
                        <p style="margin: 0; color: #475569;"><%= ann.content %></p>
                    </div>
                    <button onclick="hideAnnouncement('<%= ann.id %>')" style="background: none; border: none; color: #64748b; cursor: pointer; padding: 5px;">
                     <i class="fas fa-times-circle"></i>
                    </button>
                </div>
                <div style="margin-top: 15px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.05); font-size: 0.8rem; display: flex; justify-content: space-between;">
                    <span><%= ann.priority === 'urgent' ? 'Ø¹Ø§Ø¬Ù„' : ann.priority === 'high' ? 'Ù…Ù‡Ù…' : 'Ø¹Ø§Ø¯ÙŠ' %></span>
                    <span><%= ann.date %></span>
                </div>
            </div>
        <% }) %>
        <% if (announcements.length === 0) { %>
            <div style="text-align: center; padding: 30px; color: #94a3b8;">
                <i class="fas fa-check-double" style="font-size: 2rem;"></i>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>
            </div>
        <% } %>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-tasks"></i></div>
            <div><h3 id="todo-count">0</h3><p>Ù…Ù‡Ø§Ù…</p></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--success);"><i class="fas fa-check-double"></i></div>
            <div><h3 id="marked-sessions">0</h3><p>Ø­ØµØµ Ù…Ø±ØµÙˆØ¯Ø©</p></div>
        </div>
        <div class="stat-card" style="grid-column: span 2;">
            <div class="stat-icon" style="background: rgba(255,215,0,0.1); color: #ffd700;"><i class="fas fa-trophy"></i></div>
            <div style="flex: 1; display: flex; justify-content: space-between; align-items: center;">
                <div><h3 style="color: #ffd700;"><%= prof.stars_count || 0 %> <i class="fas fa-star"></i></h3><p>Ø±ØµÙŠØ¯ Ø§Ù„ØªÙ…ÙŠØ²</p></div>
                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; color: #ffd700;">
                    <%= (prof.stars_count || 0) >= 100 ? 'Ù…Ø¹Ù„Ù… Ù‚Ø¯ÙŠØ±' : (prof.stars_count || 0) >= 50 ? 'Ù…Ø¹Ù„Ù… Ù…ØªÙ…ÙŠØ²' : 'Ù…Ø¹Ù„Ù… Ù…Ø¨Ø§Ø¯Ø±' %>
                </span>
            </div>
        </div>
    </div>

    <section class="star-history-panel">
        <h3 onclick="toggleStarHistory()" style="cursor: pointer; display: flex; align-items: center; gap: 8px; background: #f1f5f9; padding: 10px; border-radius: 12px;">
            <i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¬ÙˆÙ… <i id="history-chevron" class="fas fa-chevron-down" style="margin-left: auto; transition: 0.3s;"></i>
        </h3>
        <div id="star-history-content" style="display: none; background: white; border-radius: 15px; padding: 10px; box-shadow: var(--shadow);">
            <% if (starHistory && starHistory.length > 0) { %>
                <% starHistory.forEach(log => { %>
                    <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px dashed #eee;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: #fff9db; color: #fab005; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-star"></i>
                            </div>
                            <div>
                                <div style="font-weight: 700;"><%= log.reason %></div>
                                <small style="color: #94a3b8;"><%= log.date %></small>
                            </div>
                        </div>
                        <span style="color: #40c057; font-weight: 900;"><%= log.points %></span>
                    </div>
                <% }) %>
            <% } else { %>
                <p style="text-align: center; color: #94a3b8; padding: 20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¨Ø¹Ø¯</p>
            <% } %>
        </div>
    </section>

    <section id="section-schedule">
        <h3 style="color: var(--primary);"><i class="fas fa-calendar-day"></i> Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…: <span id="current-day-name"></span></h3>
        <div class="banner-container">
            <div class="banner-scroll" id="banner-scroll">
                <% for(let i = 1; i <= 8; i++) { %>
                    <% let p = school_periods.find(x => x.id === i); %>
                    <div class="period-card" id="period-<%= i %>">
                        <span style="font-size: 0.7rem; color: #64748b;">Ø§Ù„Ø­ØµØ© <%= i %></span>
                        <div id="session-content-<%= i %>" style="font-size: 1.1rem; font-weight: 900; margin: 8px 0;">--</div>
                        <span style="font-size: 0.7rem; color: #94a3b8;"><%= p ? p.start_time : '--:--' %></span>
                    </div>
                <% } %>
            </div>
        </div>
    </section>

    <section id="section-attendance" class="panel">
        <div id="no-session-msg" class="hidden" style="text-align: center; padding: 40px; color: #94a3b8;">
            <i class="fas fa-hourglass-start" style="font-size: 2.5rem;"></i>
            <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØ© Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
        </div>
        <div id="attendance-active" class="hidden">
            <div style="background: #eff6ff; padding: 12px; border-radius: 12px; border-right: 5px solid var(--primary); margin-bottom: 15px;">
                <strong>Ø±ØµØ¯ ØºÙŠØ§Ø¨ ÙØµÙ„:</strong> <span id="active-class-title">--</span>
            </div>
            <form action="/teacher/absences/mark" method="POST">
                <input type="hidden" name="enseignant_id" value="<%= prof.id %>">
                <input type="hidden" name="date" id="input-date">
                <input type="hidden" name="periode" id="input-p">
                <div class="student-grid" id="student-grid-container"></div>
                <button type="submit" class="btn-submit">ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨</button>
            </form>
        </div>
    </section>

    <section id="section-behavior" class="panel">
        <h3 style="color: var(--primary);"><i class="fas fa-user-shield"></i> Ù…Ù„Ø§Ø­Ø¸Ø© Ø³Ù„ÙˆÙƒÙŠØ©</h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <div style="position: relative;">
                <input type="text" id="studentSearchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨..." style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--primary);">
                <div id="searchResultsList" class="custom-search-results"></div>
            </div>
            <div id="selectedStudentBadge" style="display: none; padding: 8px; background: #e3f2fd; border-radius: 8px;">
                ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: <strong id="selectedStudentName"></strong>
                <i class="fas fa-times" style="margin-right: 10px; cursor: pointer; color: red;" onclick="clearStudentSelection()"></i>
            </div>
            <form action="/teacher/behavior/add" method="POST">
                <input type="hidden" name="teacher_id" value="<%= prof.id %>">
                <input type="hidden" name="student_id" id="hiddenStudentId" required>
                <textarea name="event" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©..." required style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; height: 80px;"></textarea>
                <button type="submit" class="btn-submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
            </form>
        </div>
    </section>

    <section id="section-todo" class="panel">
        <h3 style="color: var(--primary);"><i class="fas fa-list-check"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h3>
        <div style="display: flex; gap: 8px;">
            <input type="text" id="todo-input" placeholder="Ø£Ø¶Ù Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©..." style="flex: 1; padding: 12px; border-radius: 12px; border: 2px solid #f1f5f9;">
            <button onclick="addTodo()" style="background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 12px; cursor: pointer;">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        <ul id="todo-list" style="list-style: none; margin-top: 15px;"></ul>
    </section>

    <div class="card secure-card" style="padding: 0; border-radius: 15px; background: white; box-shadow: var(--shadow); overflow: hidden;">
        <div onclick="toggleSecureSection()" style="padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-user-lock" style="color: var(--primary);"></i>
                <h3 style="margin: 0;">ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
            </div>
            <i class="fas fa-chevron-down" id="secure-chevron" style="transition: 0.3s;"></i>
        </div>
        <div id="secure-content" style="max-height: 0; overflow: hidden; transition: all 0.4s ease; padding: 0 20px;">
            <p style="color: #64748b;">ØºÙŠÙ‘Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø£Ù…Ø§Ù†.</p>
            <form action="/teacher/update-my-password" method="POST">
                <div class="form-row">
                    <div class="input-wrapper">
                        <i class="fas fa-key input-icon"></i>
                        <input type="password" name="new_password" id="teacher_secret_input" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©" required>
                        <button type="button" class="toggle-view-btn" onclick="handleTeacherView()">
                            <i class="fas fa-eye" id="teacher_eye_icon"></i>
                        </button>
                    </div>
                    <button type="submit" class="submit-action-btn">Ø­ÙØ¸</button>
                </div>
                <div id="pass-strength" class="strength-meter"></div>
            </form>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <a href="#top" class="nav-item active"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="#section-schedule" class="nav-item"><i class="fas fa-calendar-alt"></i>Ø§Ù„Ø¬Ø¯ÙˆÙ„</a>
    <a href="#section-attendance" class="nav-item"><i class="fas fa-user-check"></i>Ø§Ù„ØºÙŠØ§Ø¨</a>
    <a href="#section-todo" class="nav-item"><i class="fas fa-tasks"></i>Ø§Ù„Ù…Ù‡Ø§Ù…</a>
</nav>
<script>
    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    const TIMETABLE = <%- JSON.stringify(timetable || []) %>;
    const PERIODS = <%- JSON.stringify(school_periods || []) %>;
    const ELEVES = <%- JSON.stringify(eleves || []) %>;
    const SUBSTITUTIONS = <%- JSON.stringify(substitute_logs || []) %>;
    const classLocks = <%- JSON.stringify(classLocks || []) %>;
    const dayNamesAr = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];

    const cleanAr = str => str ? str.trim().replace(/[Ø£Ø¥Ø¢]/g, 'Ø§') : "";

    // Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù„Ø¬Ø¹Ù„ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø´Ø®ØµÙŠÙ‹Ø§)
    const PROF_ID = "<%= prof.id %>";
    const STORAGE_KEY = `teacher_hidden_anns_${PROF_ID}`;

    // === Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª (Ø´Ø®ØµÙŠ Ù„ÙƒÙ„ Ù…Ø¹Ù„Ù…) ===
    function hideAnnouncement(annId) {
        const card = document.getElementById('teacher-ann-' + annId);
        if (card) {
            card.style.opacity = '0';
            card.style.transform = 'translateY(-10px)';
            setTimeout(() => card.remove(), 300);
        }

        // Ø­ÙØ¸ ÙÙŠ localStorage Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… ÙÙ‚Ø·
        let hidden = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        if (!hidden.includes(annId)) {
            hidden.push(annId);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(hidden));
        }

        updateBellStatus();
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø±Ø³ (Ø¹Ø§Ø¬Ù„ Ø£Ù… Ù„Ø§)
    function updateBellStatus() {
        const visibleCards = document.querySelectorAll('.announcement-card');
        const hasUrgent = Array.from(visibleCards).some(card =>
            card.textContent.includes('Ø¹Ø§Ø¬Ù„') || 
            card.style.borderRightColor === 'rgb(239, 68, 68)' // Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± Ù„Ù„Ø¹Ø§Ø¬Ù„
        );

        const bell = document.getElementById('sidebar-bell');
        const dot = document.getElementById('urgent-dot');

        if (hasUrgent) {
            bell.classList.add('bell-urgent');
            dot.style.display = 'block';
        } else {
            bell.classList.remove('bell-urgent');
            dot.style.display = 'none';
        }
    }

    // === ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ ÙˆØ§Ù„Ø­ØµØ© Ø§Ù„Ù†Ø´Ø·Ø© ===
    function updateApp() {
        const now = new Date();
        const currentDayName = dayNamesAr[now.getDay()];
        
        if (document.getElementById('current-day-name')) {
            document.getElementById('current-day-name').textContent = currentDayName;
        }

        let activePeriod = null;

        PERIODS.forEach(p => {
            const card = document.getElementById(`period-${p.id}`);
            const content = document.getElementById(`session-content-${p.id}`);
            if (!card || !content) return;

            const normalSession = TIMETABLE.find(t => 
                Number(t.periode) === Number(p.id) && 
                cleanAr(t.jour) === cleanAr(currentDayName)
            );

            const subSession = SUBSTITUTIONS.find(s => Number(s.periode) === Number(p.id));

            if (subSession) {
                content.innerHTML = `<span class="sub-tag">Ø§Ø­ØªÙŠØ§Ø·</span> ${subSession.classe}-${subSession.section}`;
                card.classList.add('sub-active');
            } else if (normalSession) {
                content.innerHTML = `${normalSession.classe}-${normalSession.section}`;
                card.classList.remove('sub-active');
            } else {
                content.innerHTML = '<span style="opacity:0.3">Ø§Ø³ØªØ±Ø§Ø­Ø©</span>';
                card.classList.remove('sub-active');
            }

            // Ø­Ø³Ø§Ø¨ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­ØµØ© Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†
            const [hS, mS] = p.start_time.split(':').map(Number);
            const [hE, mE] = p.end_time.split(':').map(Number);
            const startMins = hS * 60 + mS;
            const endMins = hE * 60 + mE;
            const currentMins = now.getHours() * 60 + now.getMinutes();

            if (currentMins >= startMins && currentMins < endMins) {
                card.classList.add('active-now');
                activePeriod = p;
            } else {
                card.classList.remove('active-now');
            }
        });

        manageAttendanceUI(activePeriod);
    }

    // === Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ø¬Ù‡Ø© Ø±ØµØ¯ Ø§Ù„ØºÙŠØ§Ø¨ ===
    function manageAttendanceUI(period) {
        const noMsg = document.getElementById('no-session-msg');
        const activeArea = document.getElementById('attendance-active');
        const container = document.getElementById('student-grid-container');

        if (!period) {
            noMsg.classList.remove('hidden');
            activeArea.classList.add('hidden');
            return;
        }

        const session = TIMETABLE.find(s => 
            Number(s.periode) === Number(period.id) && 
            cleanAr(s.jour) === cleanAr(dayNamesAr[new Date().getDay()])
        ) || SUBSTITUTIONS.find(s => Number(s.periode) === Number(period.id));

        if (!session) {
            noMsg.classList.remove('hidden');
            activeArea.classList.add('hidden');
            return;
        }

        noMsg.classList.add('hidden');
        activeArea.classList.remove('hidden');

        document.getElementById('active-class-title').textContent = `${session.classe}-${session.section}`;
        document.getElementById('input-p').value = period.id;
        document.getElementById('input-date').value = new Date().toISOString().split('T')[0];

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙÙ„ (ØªÙ… Ø§Ù„Ø±ØµØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§)
        const isLocked = classLocks.some(l => 
            String(l.classe) === String(session.classe) && 
            String(l.section) === String(session.section) && 
            Number(l.periode) === Number(period.id)
        );

        if (isLocked || container.querySelector('.lock-message')) {
            if (!container.querySelector('.lock-message')) {
                container.innerHTML = `
                    <div class="lock-message">
                        <div style="background:#22c55e;color:white;width:60px;height:60px;line-height:60px;border-radius:50%;margin:0 auto 15px;font-size:2rem;">
                            <i class="fas fa-check"></i>
                        </div>
                        <h4 style="color:#15803d;">ØªÙ… Ø±ØµØ¯ Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­</h4>
                        <p style="color:#166534;">ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ù†Ø¬ÙˆÙ…Ùƒ</p>
                    </div>`;
            }
            // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            const submitBtn = activeArea.querySelector('.btn-submit');
            if (submitBtn) submitBtn.style.display = 'none';
        } else {
            const submitBtn = activeArea.querySelector('.btn-submit');
            if (submitBtn) submitBtn.style.display = 'block';
            renderStudents(session.classe, session.section);
        }
    }

    // === Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ø­ØµØ© ===
    function renderStudents(classe, section) {
        const container = document.getElementById('student-grid-container');
        
        // Ù„Ø§ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø³Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØµÙ„ Ù†ÙØ³Ù‡ ÙˆØºÙŠØ± Ù…Ù‚ÙÙ„
        if (container.querySelector('.lock-message')) return;
        if (container.dataset.currentClass === `${classe}-${section}`) return;

        container.dataset.currentClass = `${classe}-${section}`;
        container.innerHTML = '';

        const students = ELEVES.filter(s => 
            String(s.classe) === String(classe) && 
            String(s.section) === String(section)
        );

        if (students.length === 0) {
            container.innerHTML = '<p style="text-align:center;padding:30px;color:#94a3b8;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„</p>';
            return;
        }

        students.forEach(student => {
            container.innerHTML += `
                <div class="student-card">
                    <span>${student.nom}</span>
                    <label class="switch">
                        <input type="checkbox" name="eleve_ids[]" value="${student.id}">
                        <span class="slider"></span>
                    </label>
                </div>`;
        });
    }

    // === Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø´Ø®ØµÙŠØ© ===
    function addTodo() {
        const input = document.getElementById('todo-input');
        const list = document.getElementById('todo-list');
        if (!input.value.trim()) return;

        const li = document.createElement('li');
        li.style = "background:white;padding:10px 15px;border-radius:10px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;border:1px solid #f1f5f9;";
        li.innerHTML = `
            <span>${input.value}</span>
            <button onclick="this.parentElement.remove(); updateTodoCounter()" style="background:none;border:none;color:#94a3b8;cursor:pointer;">
                <i class="fas fa-trash-alt"></i>
            </button>`;
        list.appendChild(li);
        input.value = '';
        updateTodoCounter();
    }

    function updateTodoCounter() {
        const count = document.getElementById('todo-list').children.length;
        document.getElementById('todo-count').textContent = count;
    }

    // === Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ© ===
    const searchInput = document.getElementById('studentSearchInput');
    const resultsList = document.getElementById('searchResultsList');
    const hiddenId = document.getElementById('hiddenStudentId');
    const badge = document.getElementById('selectedStudentBadge');
    const badgeName = document.getElementById('selectedStudentName');

    if (searchInput) {
        searchInput.addEventListener('input', () => {
            const term = searchInput.value.trim().toLowerCase();
            resultsList.innerHTML = '';
            if (term.length < 2) {
                resultsList.style.display = 'none';
                return;
            }

            const matches = ELEVES.filter(s => s.nom.toLowerCase().includes(term));
            if (matches.length > 0) {
                matches.forEach(s => {
                    const item = document.createElement('div');
                    item.className = 'search-item';
                    item.innerHTML = `<strong>${s.nom}</strong><br><span>${s.classe}-${s.section}</span>`;
                    item.onclick = () => {
                        hiddenId.value = s.id;
                        badgeName.textContent = s.nom;
                        badge.style.display = 'block';
                        searchInput.value = '';
                        resultsList.style.display = 'none';
                    };
                    resultsList.appendChild(item);
                });
                resultsList.style.display = 'block';
            } else {
                resultsList.style.display = 'none';
            }
        });

        document.addEventListener('click', e => {
            if (!searchInput.contains(e.target) && !resultsList.contains(e.target)) {
                resultsList.style.display = 'none';
            }
        });
    }

    function clearStudentSelection() {
        hiddenId.value = '';
        badge.style.display = 'none';
        searchInput.value = '';
    }

    // === ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø­Ø³Ø§Ø¨ ===
    function toggleSecureSection() {
        const content = document.getElementById('secure-content');
        const chevron = document.getElementById('secure-chevron');
        content.classList.toggle('secure-open');
        chevron.classList.toggle('rotate-chevron');
    }

    function handleTeacherView() {
        const input = document.getElementById('teacher_secret_input');
        const icon = document.getElementById('teacher_eye_icon');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    document.getElementById('teacher_secret_input')?.addEventListener('input', e => {
        const meter = document.getElementById('pass-strength');
        const len = e.target.value.length;
        meter.style.width = len === 0 ? '0' : len < 4 ? '30%' : len < 8 ? '60%' : '100%';
        meter.style.background = len < 4 ? '#ef4444' : len < 8 ? '#f59e0b' : '#22c55e';
    });

    // === Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¬ÙˆÙ… ===
    function toggleStarHistory() {
        const content = document.getElementById('star-history-content');
        const chevron = document.getElementById('history-chevron');
        if (content.style.display === 'none' || !content.style.display) {
            content.style.display = 'block';
            chevron.style.transform = 'rotate(180deg)';
        } else {
            content.style.display = 'none';
            chevron.style.transform = 'rotate(0)';
        }
    }

    // === ØªØ£Ø«ÙŠØ± Ø§Ù„ÙƒÙˆÙ†ÙÙŠØªÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø§Ø¬Ø­ ===
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('success') && urlParams.get('success') === 'evaluated') {
        confetti({
            particleCount: 120,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#ffd700', '#1e3a8a', '#22c55e']
        });
        // ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø·ÙŠÙ (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ù€ toast Ø£Ø¬Ù…Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§)
        setTimeout(() => alert('ğŸ‰ Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ! ØªÙ… Ù…Ù†Ø­Ùƒ Ù†Ø¬Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­'), 1000);
        // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ØªØ± Ù…Ù† Ø§Ù„Ù€ URL Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
        history.replaceState({}, '', location.pathname);
    }

    // === Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ===
    document.addEventListener('DOMContentLoaded', () => {
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø®ÙÙŠØ© Ø³Ø§Ø¨Ù‚Ù‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… ÙÙ‚Ø·
        const hidden = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        hidden.forEach(id => {
            const card = document.getElementById('teacher-ann-' + id);
            if (card) card.remove();
        });

        updateBellStatus();
        updateTodoCounter();
        updateApp();

        // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
        setInterval(updateApp, 10000);
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>


</body>
</html>