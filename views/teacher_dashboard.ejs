<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= titre %> - Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯</title>
    <style>
        :root {
            --primary-dark: #2c3e50;
            --danger: #e74c3c;
            --success: #27ae60;
            --warning: #ff9800;
            --info: #3498db;
            --bg-light: #f0f2f5;
        }

        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg-light); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: auto; }

        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø£Ù‚Ø³Ø§Ù… */
        .section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 25px; }
        h2 { color: var(--primary-dark); border-bottom: 2px solid #eee; padding-bottom: 12px; margin-top: 0; display: flex; align-items: center; gap: 10px; }
        
        .header { background: var(--primary-dark); color: white; padding: 20px 30px; border-radius: 12px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .btn-logout { background: var(--danger); color: white; padding: 8px 15px; text-decoration: none; border-radius: 6px; font-weight: bold; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…ÙŠ */
        .timetable-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .time-slot { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; text-align: center; border-top: 4px solid var(--info); }
        .time-slot.active { background: #e8f4fd; border-color: var(--info); }
        .time-slot b { display: block; color: var(--primary-dark); margin-bottom: 5px; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³Ù„ÙˆÙƒ */
        .behavior-form { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .form-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 200px; }
        input, select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .btn-save { background: var(--primary-dark); color: white; border: none; padding: 10px 25px; border-radius: 6px; cursor: pointer; height: 42px; font-weight: bold; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #f4f7f6; }
        .student-row { display: none; }
    </style>
</head>
<body>

<div class="container">
    
    <% if (success) { %><div style="background:#d4edda; color:#155724; padding:15px; border-radius:8px; margin-bottom:20px;">âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­.</div><% } %>

    <div class="header">
        <div>
            <h1>Ø£Ù‡Ù„Ø§Ù‹ØŒ Ø£Ø³ØªØ§Ø°/ <%= prof.nom %></h1>
            <p>ØªØ®ØµØµ: <%= prof.matiere %> | Ø§Ù„ÙŠÙˆÙ…: <%= today %></p>
        </div>
        <a href="/logout" class="btn-logout">Ø®Ø±ÙˆØ¬ ğŸšª</a>
    </div>

    <div class="section">
        <h2>ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…</h2>
        <div class="timetable-grid">
            <% if (sessions.length === 0) { %>
                <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­ØµØµ Ù…Ø³Ø¬Ù„Ø© Ù„Ùƒ Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„.</p>
            <% } else { %>
                <% // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­ØµØµ Ø­Ø³Ø¨ Ø§Ù„Ø±Ù‚Ù…
                   sessions.sort((a,b) => a.periode - b.periode).forEach(s => { %>
                    <div class="time-slot">
                        <b>Ø§Ù„Ø­ØµØ© <%= s.periode %></b>
                        <span><%= s.classe %> / <%= s.section %></span>
                    </div>
                <% }) %>
            <% } %>
        </div>
    </div>

    <div class="section" style="border-right: 6px solid var(--warning); background: #fff9f0;">
        <h2>ğŸ“¢ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
        <% if (replacements.length === 0) { %>
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØºÙŠØ§Ø¨Ø§Øª Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„ÙŠÙˆÙ….</p>
        <% } else { %>
            <% replacements.forEach(t => { %>
                <div style="margin-bottom:10px; padding:10px; background:white; border-radius:5px; border:1px solid #ffe0b2;">
                    âš ï¸ ØºÙŠØ§Ø¨: <b><%= t.nom %></b> (<%= t.matiere %>) - Ø§Ù„Ø³Ø¨Ø¨: <%= t.raison %>
                </div>
            <% }) %>
        <% } %>
    </div>

    <div class="section">
        <h2>ğŸ“ Ø±ØµØ¯ ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
        <form action="/teacher/absences/mark" method="POST">
            <input type="hidden" name="teacher_id" value="<%= prof.id %>">
            <input type="hidden" name="date" value="<%= today %>">
            
            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px; display:flex; gap:20px;">
                <div class="form-group">
                    <label>Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ø­ØµØ©:</label>
                    <select name="periode" id="sessionSelect" required onchange="filterStudents()">
                        <option value="" disabled selected>-- Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ --</option>
                        <% sessions.forEach(s => { %>
                            <option value="<%= s.periode %>" data-class="<%= s.classe %>-<%= s.section %>">
                                Ø§Ù„Ø­ØµØ© <%= s.periode %>: <%= s.classe %> / <%= s.section %>
                            </option>
                        <% }) %>
                    </select>
                </div>
            </div>

            <table id="attendanceTable" style="display:none;">
                <thead>
                    <tr><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØºÙŠØ§Ø¨</th></tr>
                </thead>
                <tbody>
                    <% students.forEach(s => { %>
                        <tr class="student-row" data-class-id="<%= s.classe %>-<%= s.section %>">
                            <td><%= s.nom %></td>
                            <td><%= s.classe %> / <%= s.section %></td>
                            <td><input type="checkbox" name="student_ids[]" value="<%= s.id %>"> ØºØ§Ø¦Ø¨</td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
            <button type="submit" id="submitBtn" style="display:none; margin-top:20px; width:100%; padding:12px; background:var(--success); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Ø­ÙØ¸ ÙƒØ´Ù Ø§Ù„ØºÙŠØ§Ø¨</button>
        </form>
    </div>

    <div class="section">
        <h2>âš–ï¸ Ø³Ø¬Ù„ Ø§Ù„Ø³Ù„ÙˆÙƒ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
        <form action="/teacher/behavior/add" method="POST" class="behavior-form">
            <input type="hidden" name="teacher_id" value="<%= prof.id %>">
            
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                <select name="student_id" required>
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ --</option>
                    <% students.forEach(s => { %>
                        <option value="<%= s.id %>"><%= s.nom %> (<%= s.classe %> / <%= s.section %>)</option>
                    <% }) %>
                </select>
            </div>

            <div class="form-group" style="flex: 2;">
                <label>ÙˆØµÙ Ø§Ù„Ø­Ø¯Ø« Ø£Ùˆ Ø§Ù„Ø³Ù„ÙˆÙƒ:</label>
                <input type="text" name="event_desc" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø´Ø§ØºØ¨Ø© ÙÙŠ Ø§Ù„Ø­ØµØ©ØŒ ØªÙ…ÙŠØ² ÙÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©..." required>
            </div>

            <button type="submit" class="btn-save">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« âœ…</button>
        </form>
    </div>

</div>

<script>
    function filterStudents() {
        const select = document.getElementById('sessionSelect');
        const target = select.options[select.selectedIndex].getAttribute('data-class');
        const rows = document.querySelectorAll('.student-row');
        const table = document.getElementById('attendanceTable');
        const btn = document.getElementById('submitBtn');

        let count = 0;
        rows.forEach(row => {
            if (row.getAttribute('data-class-id') === target) {
                row.style.display = 'table-row';
                count++;
            } else {
                row.style.display = 'none';
            }
        });

        table.style.display = count > 0 ? 'table' : 'none';
        btn.style.display = count > 0 ? 'block' : 'none';
    }
</script>

</body>
</html>