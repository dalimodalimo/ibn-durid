<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title><%= titre %> - مدرسة ابن دريد</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/teacher_inter_style.css">  
    <style>
        /* التنسيقات الأساسية وتحسينات الواجهة */
        .top-info-bar {
            background: linear-gradient(135deg, #1a237e, #3949ab);
            color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .live-clock { font-size: 1.6rem; font-weight: bold; letter-spacing: 1px; }
        .live-date { font-size: 0.95rem; opacity: 0.9; text-align: left; }

        .announcements-container {
            margin-bottom: 20px; border-radius: 15px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: all 0.5s ease;
        }
        .ann-header {
            background: #fff3cd; color: #856404; padding: 10px 15px;
            display: flex; align-items: center; gap: 10px; font-weight: bold;
        }
        .ann-list { background: #fff; padding: 10px 15px; border: 1px solid #ffeeba; }
        
        .ann-item { 
            border-bottom: 1px dashed #ddd; padding: 10px 0; 
            display: flex; justify-content: space-between; align-items: center;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1; transform: translateX(0);
        }
        .ann-item:last-child { border-bottom: none; }
        .ann-fade-out { opacity: 0; transform: translateX(50px); max-height: 0; padding: 0; margin: 0; overflow: hidden; pointer-events: none; }

        .btn-ann-ok {
            background: #27ae60; color: white; border: none;
            padding: 5px 12px; border-radius: 6px; cursor: pointer;
            font-size: 0.8rem; font-weight: bold; transition: 0.3s;
        }

        .timetable-scroll-wrapper { background: #ffffff; border-radius: 15px; padding: 15px; }
        .horiz-scroll-container { display: flex; gap: 12px; overflow-x: auto; padding: 10px 5px 20px 5px; scroll-snap-type: x mandatory; }
        
        /* تحسينات الحصص (الحالات الثلاث) */
        .period-item { min-width: 145px; flex-shrink: 0; background: #f8fafc; border-radius: 12px; padding: 12px; border: 1px solid #e2e8f0; text-align: center; scroll-snap-align: center; transition: 0.3s; }
        .period-item.has-class { border: 2px solid #4f46e5; background: #eef2ff; }
        
        /* 1. الحصة الجارية (باللون الأحمر) */
        .period-item.starting-soon:not(.marked-done) { 
            border: 3px solid #ef4444 !important; 
            background: #fff1f2 !important; 
            animation: pulse-red 2s infinite; 
        }

        /* 2. الحصة المكتملة (باللون الرمادي) */
        .period-item.marked-done {
            background: #f1f5f9 !important;
            border: 2px solid #cbd5e1 !important;
            color: #64748b;
            filter: grayscale(0.5);
        }
        .marked-badge { color: #22c55e; font-size: 0.75rem; font-weight: bold; display: block; margin-top: 5px; }

        .period-item.is-substitute { border: 2px dashed #f59e0b !important; background: #fffbeb !important; }

        #sessionSelect.unmarked { border: 2px solid #ef4444 !important; }
        .disabled-view { filter: grayscale(1); opacity: 0.7; pointer-events: none; position: relative; }
        .disabled-view::after { 
            content: "تم رصد الغياب ✅"; position: absolute; top: 10px; left: 50%; 
            transform: translateX(-50%); background: #22c55e; color: white; padding: 5px 15px; 
            border-radius: 20px; font-size: 0.8rem; z-index: 10; 
        }

        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .hidden { display: none !important; }
        .search-input-wrapper { position: relative; margin-bottom: 10px; }
        .search-input-wrapper i { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .search-input-wrapper input { width: 100%; padding: 12px 35px 12px 12px; border-radius: 10px; border: 1px solid #ddd; outline: none; }
        
        .student-card { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <img src="/img/logo.png" alt="Logo" class="sidebar-logo"> <h3>لوحة المعلم</h3>
        <button class="close-sidebar" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
    </div>
    <ul class="sidebar-links">
        <li><a href="#" onclick="toggleSidebar()"><i class="fas fa-home"></i> الرئيسية</a></li>
        <li><a href="#timetableSection" onclick="toggleSidebar()"><i class="fas fa-calendar-alt"></i> جدول الحصص</a></li>
        <li><a href="#attendanceSection" onclick="toggleSidebar()"><i class="fas fa-user-check"></i> رصد الغياب</a></li>
        <li><a href="#behaviorSection" onclick="toggleSidebar()"><i class="fas fa-pen-fancy"></i> ملاحظات سلوكية</a></li>
        <li class="separator"></li>
        <li><a href="/logout" class="logout-link"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
    </ul>
</nav>

<div class="container">
    <% if (typeof success !== 'undefined' && success) { %>
        <div class="toast success-toast" style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
            <i class="fas fa-check-circle"></i> تم تنفيذ العملية بنجاح.
        </div>
    <% } %>

    <header class="main-header">
        <div class="header-right">
            <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <div class="user-info-mini">
                <h1>أستاذ/ <%= prof.nom %></h1>
            </div>
        </div>
        <div class="avatar-mini"><i class="fas fa-user-circle"></i></div>
    </header>

    <% if (typeof announcements !== 'undefined' && announcements.length > 0) { %>
    <section class="announcements-container" id="annContainer">
        <div class="ann-header"><i class="fas fa-bullhorn"></i> إعلانات الإدارة</div>
        <div class="ann-list" id="annList">
            <% announcements.forEach((ann, index) => { %>
                <div class="ann-item" id="ann-item-<%= index %>" data-ann-id="<%= ann.id %>">
                    <div class="ann-content-wrapper">
                        <strong><%= ann.title %></strong>: <%= ann.content %>
                        <br><small><%= ann.date %></small>
                    </div>
                    <button class="btn-ann-ok" onclick="dismissAnnouncement('<%= index %>')">فهمت</button>
                </div>
            <% }) %>
        </div>
    </section>
    <% } %>

    <section class="section no-padding" id="timetableSection">
        <div class="top-info-bar">
            <div class="live-clock" id="current-clock">00:00:00</div>
            <div class="live-date" id="current-date">جاري التحميل...</div>
        </div>
        <div class="section-header pd-20">
            <i class="fas fa-calendar-day"></i> <h2>جدول الحصص اليومي</h2>
        </div>
        <div class="timetable-scroll-wrapper">
            <div class="horiz-scroll-container">
                <% for(let i=1; i<=8; i++) { 
                    let pTime = periods.find(p => p.id === i);
                    let session = sessions.find(s => s.periode === i);
                    let isSub = session && session.isSubstitute;
                    let isMarked = session && session.is_marked;
                %>
                    <div class="period-item <%= session ? (isSub ? 'is-substitute' : 'has-class') : '' %> <%= isMarked ? 'marked-done' : '' %>" 
                         id="period-<%= i %>" 
                         data-start="<%= pTime ? pTime.start_time : '' %>"
                         data-end="<%= pTime ? pTime.end_time : '' %>">
                        <span class="p-num">الحصة <%= i %></span>
                        <span class="p-time"><%= pTime ? pTime.start_time : '--:--' %></span>
                        <div class="p-content">
                            <% if(session) { %>
                                <span class="p-class"><%= session.classe %> / <%= session.section %></span>
                                <% if(isMarked) { %>
                                    <span class="marked-badge"><i class="fas fa-check-circle"></i> تم الرصد</span>
                                <% } else { %>
                                    <span class="p-subject"><%= session.matiere %></span>
                                <% } %>
                            <% } else { %>
                                <span class="p-free">فراغ</span>
                            <% } %>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
    </section>

    <section class="section main-section" id="attendanceSection">
        <div class="section-header"><i class="fas fa-user-check"></i> <h2>رصد غياب الطلاب</h2></div>
        <form action="/teacher/absences/mark" method="POST" id="attendanceForm">
            <input type="hidden" name="teacher_id" value="<%= prof.id %>">
            <input type="hidden" name="date" value="<%= today %>">
            
            <div class="selection-box">
                <select name="periode" id="sessionSelect" required onchange="handleSessionChange()">
                    <option value="" disabled selected>-- اختر الحصة لرؤية الطلاب --</option>
                    <% sessions.sort((a,b)=>a.periode-b.periode).forEach(s => { 
                        let pTime = periods.find(p => p.id === s.periode);
                    %>
                        <option value="<%= s.periode %>" 
                                data-class-full="<%= s.classe %>-<%= s.section %>"
                                data-marked="<%= s.is_marked || false %>"
                                data-start="<%= pTime ? pTime.start_time : '' %>"
                                data-end="<%= pTime ? pTime.end_time : '' %>">
                            الحصة <%= s.periode %>: <%= s.classe %>/<%= s.section %> <%= s.is_marked ? '(تم الرصد ✅)' : '' %>
                        </option>
                    <% }) %>
                </select>
            </div>

            <div id="attendanceSearchWrapper" class="search-input-wrapper hidden">
                <i class="fas fa-search"></i>
                <input type="text" id="attendanceSearch" placeholder="بحث عن طالب...">
            </div>

            <div id="tableContainer" class="table-container hidden">
                <div class="student-list-mobile" id="attendanceStudentList">
                    <% students.forEach(s => { %>
                        <div class="student-card student-row" data-class-id="<%= s.classe %>-<%= s.section %>" style="display: none;">
                            <span class="student-name"><%= s.nom %></span>
                            <label class="switch">
                                <input type="checkbox" name="student_ids[]" value="<%= s.id %>">
                                <span class="slider-toggle"></span> (غائب)
                            </label>
                        </div>
                    <% }) %>
                </div>
                <button type="submit" id="submitBtn" class="btn-submit-full" style="width: 100%; padding: 15px; background: #1a237e; color: white; border: none; border-radius: 10px; margin-top: 15px;">إرسال الغياب</button>
            </div>
        </form>
    </section>

    <section class="section behavior-section" id="behaviorSection">
        <div class="section-header"><i class="fas fa-pen-nib"></i> <h2>ملاحظة سلوكية</h2></div>
        <div class="search-input-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" id="behaviorSearch" placeholder="ابحث عن الطالب...">
        </div>
        <form action="/teacher/behavior/add" method="POST" class="quick-form">
            <input type="hidden" name="teacher_id" value="<%= prof.id %>">
            <select name="student_id" id="behaviorStudentSelect" required style="width: 100%; padding: 10px; margin-bottom: 10px;">
                <option value="">اختر الطالب...</option>
                <% students.forEach(s => { %>
                    <option value="<%= s.id %>">
                        <%= s.nom %> (<%= s.classe %>/<%= s.section %>)
                    </option>
                <% }) %>
            </select>
            <textarea name="event_text" placeholder="اكتب الملاحظة هنا..." required style="width: 100%; height: 80px; padding: 10px;"></textarea>
            <button type="submit" class="btn-save-full" style="width: 100%; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 5px;">حفظ الملاحظة</button>
        </form>
    </section>
</div>

<script>
    // جلب رقم المعلم الحالي من EJS ليتم استخدامه في مفاتيح التخزين
    const CURRENT_PROF_ID = "<%= prof.id %>";

    // 1. وظائف الإعلانات (محدثة لتعمل لكل معلم بشكل مستقل)
    function dismissAnnouncement(index) {
        const annItem = document.getElementById('ann-item-' + index);
        if (!annItem) return;

        const annId = annItem.getAttribute('data-ann-id');
        annItem.classList.add('ann-fade-out');
        
        // الحل: ننشئ مفتاح تخزين فريد يجمع بين (رقم الإعلان) و (رقم المعلم)
        // سيتم التخزين هكذا: read_ann_12_teacher_5
        const storageKey = `read_ann_${annId}_prof_${CURRENT_PROF_ID}`;
        localStorage.setItem(storageKey, 'true');

        setTimeout(() => {
            annItem.remove();
            checkEmptyAnnouncements();
        }, 500);
    }

    function checkReadAnnouncements() {
        document.querySelectorAll('.ann-item').forEach(item => {
            const annId = item.getAttribute('data-ann-id');
            // نبحث عن مفتاح التخزين الخاص بهذا المعلم وهذا الإعلان تحديداً
            const storageKey = `read_ann_${annId}_prof_${CURRENT_PROF_ID}`;
            
            if (localStorage.getItem(storageKey) === 'true') {
                item.remove(); 
            }
        });
        checkEmptyAnnouncements();
    }

    function checkEmptyAnnouncements() {
        const remainingItems = document.querySelectorAll('.ann-item');
        const container = document.getElementById('annContainer');
        if (remainingItems.length === 0 && container) {
            container.style.display = 'none';
        }
    }

    // 2. وظائف الساعة والوقت
    function updateClock() {
        const now = new Date();
        const clockEl = document.getElementById('current-clock');
        const dateEl = document.getElementById('current-date');
        
        if (clockEl) clockEl.textContent = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        if (dateEl) dateEl.textContent = now.toLocaleDateString('ar-SA', { weekday: 'long', day: 'numeric', month: 'long' });
        
        const currentMins = now.getHours() * 60 + now.getMinutes();

        document.querySelectorAll('.period-item').forEach(item => {
            const start = item.getAttribute('data-start');
            const end = item.getAttribute('data-end');
            if (!start || !end) return;

            const [hS, mS] = start.split(':').map(Number);
            const [hE, mE] = end.split(':').map(Number);
            const startMins = hS * 60 + mS;
            const endMins = hE * 60 + mE;

            if (currentMins >= startMins && currentMins <= endMins) {
                item.classList.add('starting-soon');
            } else {
                item.classList.remove('starting-soon');
            }
        });
    }

    // 3. وظائف رصد الغياب والبحث
    function handleSessionChange() {
        const select = document.getElementById('sessionSelect');
        const selected = select.selectedOptions[0];
        if (!selected) return;

        const targetClass = selected.getAttribute('data-class-full');
        const isMarked = selected.getAttribute('data-marked') === 'true';
        
        document.querySelectorAll('.student-card').forEach(card => {
            if (card.getAttribute('data-class-id') === targetClass) {
                card.style.display = 'flex';
            } else {
                card.style.display = 'none';
            }
        });

        document.getElementById('tableContainer').classList.remove('hidden');
        document.getElementById('attendanceSearchWrapper').classList.remove('hidden');
        
        const submitBtn = document.getElementById('submitBtn');
        if (isMarked) {
            document.getElementById('tableContainer').classList.add('disabled-view');
            submitBtn.disabled = true;
            submitBtn.innerText = "تم رصد الغياب لهذه الحصة ✅";
        } else {
            document.getElementById('tableContainer').classList.remove('disabled-view');
            submitBtn.disabled = false;
            submitBtn.innerText = "إرسال كشف الغياب";
        }
    }

    // 4. تشغيل النظام عند التحميل
   document.addEventListener('DOMContentLoaded', () => {
        // 1. فحص الإعلانات المقروءة
        checkReadAnnouncements();
        
        // 2. تشغيل وتحديث الساعة
        updateClock();
        setInterval(updateClock, 1000);

        // 3. إخفاء رسالة النجاح (التوست) تلقائياً بعد 4 ثوانٍ
        const successToast = document.querySelector('.success-toast');
        if (successToast) {
            setTimeout(() => {
                successToast.style.transition = "opacity 0.6s ease, transform 0.6s ease";
                successToast.style.opacity = "0";
                successToast.style.transform = "translateY(-10px)";
                setTimeout(() => successToast.remove(), 600);
            }, 4000); // 4 ثوانٍ
        }

        // 4. تفعيل مستمع البحث عن الطلاب
        const searchInput = document.getElementById('attendanceSearch');
        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                const filter = this.value.toLowerCase();
                const selected = document.getElementById('sessionSelect').selectedOptions[0];
                if (!selected) return;
                const targetClass = selected.getAttribute('data-class-full');

                document.querySelectorAll('.student-card').forEach(card => {
                    const name = card.querySelector('.student-name').innerText.toLowerCase();
                    const sameClass = card.getAttribute('data-class-id') === targetClass;
                    card.style.display = (sameClass && name.includes(filter)) ? 'flex' : 'none';
                });
            });
        }
    });

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('sidebarOverlay').classList.toggle('active');
    }
</script>
</body>
</html>