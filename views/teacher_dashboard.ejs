<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title><%= titre %> - Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯ | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
/* ØªÙ†Ø³ÙŠÙ‚ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù‚ÙÙ„ */
.lock-message {
    grid-column: 1/-1;
    text-align: center;
    padding: 40px 20px;
    background: linear-gradient(145deg, #ffffff, #f1f8e9);
    border-radius: 20px;
    border: 2px solid #a5d6a7;
    box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    animation: fadeIn 0.5s ease-in-out;
}

.lock-message i {
    font-size: 3rem;
    color: #2e7d32;
    background: #c8e6c9;
    width: 80px;
    height: 80px;
    line-height: 80px;
    border-radius: 50%;
    margin-bottom: 15px;
}

/* Ø­Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø© Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø­ØµØµ Ø§Ù„ØªÙŠ ØªÙ… Ø±ØµØ¯Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
.period-card.is-done {
    border-right: 5px solid #4caf50 !important;
    position: relative;
}

.period-card.is-done::after {
    content: 'âœ…';
    position: absolute;
    top: 5px;
    left: 5px;
    font-size: 0.8rem;
}



    .custom-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 0 0 10px 10px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 999;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .search-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
    }
    .search-item:hover {
        background: #f8f9fa;
        color: var(--primary);
    }
    .search-item span {
        font-size: 0.8rem;
        color: #777;
    }

        :root {
            --primary: #1e3a8a;
            --primary-gradient: linear-gradient(135deg, #1e3a8a, #3b82f6);
            --accent: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --radius-xl: 24px;
            --radius-lg: 16px;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; scroll-behavior: smooth; }
        body { background-color: var(--bg); color: #1e293b; line-height: 1.6; padding-bottom: 90px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; display: flex; flex-direction: column; gap: 20px; }
        .hidden { display: none !important; }

        .period-card.sub-active {
            background-color: #fef9c3 !important; 
            border: 2px solid #facc15 !important; 
        }
        .sub-tag {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            background: #eab308; color: white; font-size: 0.55rem; padding: 2px 8px;
            border-radius: 20px; font-weight: 900; white-space: nowrap;
        }

        .main-header {
            background: var(--primary-gradient); color: white; padding: 20px; border-radius: 0 0 var(--radius-xl) var(--radius-xl);
            display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow);
            position: sticky; top: 0; z-index: 1000;
        }
        .header-user h1 { font-size: 1.1rem; font-weight: 900; }
        .btn-logout { background: rgba(255,255,255,0.2); color: white; text-decoration: none; padding: 5px 12px; border-radius: 10px; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.3); display: inline-block; margin-top: 5px; }

        .live-clock-box { text-align: left; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 12px; }
        #live-clock { font-size: 1.2rem; font-weight: 900; display: block; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            display: flex; justify-content: space-around; padding: 12px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); border-top: 1px solid #edf2f7; z-index: 1000;
        }
        .nav-item { text-decoration: none; color: #94a3b8; text-align: center; font-size: 0.7rem; font-weight: 600; }
        .nav-item i { font-size: 1.3rem; display: block; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }

        .substitution-alert {
            background: #fff3cd; border-right: 6px solid var(--warning);
            padding: 15px; border-radius: var(--radius-lg); display: flex; 
            flex-direction: column; gap: 10px; box-shadow: var(--shadow); animation: slideDown 0.5s ease-out;
        }
        .sub-info { display: flex; align-items: center; gap: 10px; }
        .sub-info i { font-size: 1.5rem; color: var(--warning); animation: pulse-icon 1.5s infinite; }
        .btn-accept { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; }

        .admin-notif-bar {
            background: #e0f2fe; border-right: 6px solid var(--primary);
            padding: 15px; border-radius: 15px; display: flex; align-items: center; gap: 12px; animation: slideDown 0.5s ease;
        }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: var(--card-bg); padding: 15px; border-radius: var(--radius-lg); box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; border-bottom: 4px solid var(--primary); }
        .stat-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: #eff6ff; color: var(--primary); }

        .banner-container { background: #e2e8f0; padding: 20px 10px; border-radius: 25px; overflow: hidden; }
        .banner-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .banner-scroll::-webkit-scrollbar { display: none; }
        .period-card { min-width: 140px; background: white; border-radius: 18px; padding: 15px 10px; text-align: center; flex-shrink: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative;}
        .period-card.active-now { border: 2px solid var(--accent); background: #fff1f2; transform: scale(1.02); animation: pulse-border 2s infinite; }
        
        .panel { background: var(--card-bg); border-radius: var(--radius-xl); padding: 20px; box-shadow: var(--shadow); }
        .student-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px; }
        .student-card { background: #f1f5f9; padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0; }

        .todo-section { background: var(--card-bg); padding: 20px; border-radius: var(--radius-xl); box-shadow: var(--shadow); }
        .btn-submit { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 15px; font-weight: 700; cursor: pointer; }
        
        .switch { position: relative; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background: #cbd5e1; border-radius: 34px; transition: 0.4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.4s; }
        input:checked + .slider { background: var(--accent); }
        input:checked + .slider:before { transform: translateX(22px); }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-icon { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
   
   /* Ø­Ù„ ØªØ¹Ø§Ø±Ø¶ Grid ÙÙŠ Ù‚Ø³Ù… Ø§Ù„ØºÙŠØ§Ø¨ */
#student-grid-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    width: 100%;
}

/* ØªØ£ÙƒÙŠØ¯ Ø£Ù† Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„ ØªØ£Ø®Ø° Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØªØºØ·ÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© */
#student-grid-container .lock-message {
    grid-column: 1 / -1; /* ÙŠÙ…ØªØ¯ Ø¹Ù„Ù‰ ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    margin: 10px 0;
    z-index: 10;
}

/* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø±Ø³Ø§Ù„Ø© Ù‚ÙÙ„ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¯Ø§Ø®Ù„ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ */
#attendance-active:has(.lock-message) .btn-submit {
    display: none !important;
}
   </style>
</head>
<body id="top">

<header class="main-header">
    <div class="header-user">
        <h1>Ø£Ù‡Ù„Ø§Ù‹ Ø£/ <%= prof.nom %></h1>
        <div style="background: rgba(255, 215, 0, 0.2); color: #ffd700; padding: 4px 10px; border-radius: 8px; display: inline-flex; align-items: center; gap: 6px; margin-top: 5px; border: 1px solid rgba(255, 215, 0, 0.3); font-size: 0.85rem; font-weight: 700;">
            <i class="fas fa-star"></i>
            <span><%= prof.stars_count || 0 %> Ù†Ø¬Ù…Ø©</span>
        </div>
        <br>
        <a href="/logout" class="btn-logout"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
    </div>
    <div class="live-clock-box">
        <span id="live-clock">00:00:00</span>
        <small id="current-status-text" style="font-size: 0.6rem; opacity: 0.8;">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø¬Ø¯ÙˆÙ„...</small>
    </div>
</header>

<% if (typeof evaluation_requests !== 'undefined' && evaluation_requests.length > 0) { %>
    <div id="eval-requests-container" style="margin-bottom: 20px; padding: 0 15px;">
        <% evaluation_requests.forEach(req => { %>
            <div class="admin-notif-bar" style="background: #fdf2f8; border-right: 6px solid #db2777; display: flex; align-items: center; padding: 15px; border-radius: 15px; margin-bottom: 10px;">
                <i class="fas fa-star" style="color: #db2777; margin-left: 15px; font-size: 1.2rem;"></i>
                <div style="flex:1; font-size: 0.85rem;">
                    <div style="font-weight: 800; color: #9d174d;">Ø·Ù„Ø¨ ØªÙ‚ÙŠÙŠÙ… Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</div>
                    <div style="color: #4b5563;">
                        ÙŠØ±Ø¬Ù‰ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ø§Ù„Ø¨: <strong><%= req.student_name || 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…...' %></strong> 
                        <span style="background: #fae8f0; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-right: 5px;"><%= req.classe %></span>
                    </div>
                </div>
                <a href="/teacher/evaluate/<%= req.id %>/<%= req.eleve_id %>" style="background: #db2777; color: white; padding: 8px 15px; border-radius: 8px; text-decoration: none; font-size: 0.8rem; font-weight: bold;">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¢Ù†</a>
            </div>
        <% }) %>
    </div>
<% } %>

<div class="container">
    
    <% if (typeof substitute_logs !== 'undefined' && substitute_logs.length > 0) { %>
        <div id="sub-requests-container">
            <% substitute_logs.filter(s => s.status === 'pending').forEach(sub => { %>
                <div class="substitution-alert">
                    <div class="sub-info">
                        <i class="fas fa-clock-rotate-left"></i>
                        <div>
                            <h4 style="color: #856404; font-size: 0.9rem;">ØªÙˆØ²ÙŠØ¹ Ø­ØµØ© Ø§Ø­ØªÙŠØ§Ø·</h4>
                            <p style="font-size: 0.8rem;">Ø§Ù„Ø­ØµØ©: <%= sub.periode %> | Ø§Ù„ÙØµÙ„: <%= sub.classe %>-<%= sub.section %></p>
                        </div>
                    </div>
                   <form action="/teacher/substitute/respond" method="POST">
    <input type="hidden" name="sub_id" value="<%= sub.id %>">
    <input type="hidden" name="action" value="accept">
    <input type="hidden" name="teacher_id" value="<%= prof.id %>"> 
    
    <button type="submit" class="btn-accept" style="background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
        <i class="fas fa-check"></i> Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø­ØµØ©
    </button>
</form>
                </div>
            <% }) %>
        </div>
    <% } %>

    <% if (typeof announcements !== 'undefined' && announcements.length > 0) { %>
        <div id="admin-announcements-container">
            <% announcements.forEach(ann => { %>
                <div class="admin-notif-bar" id="ann-box-<%= ann.id %>">
                    <i class="fas fa-bullhorn"></i>
                    <div style="flex:1; font-size: 0.85rem;">
                        <div style="font-weight: 800; color: var(--primary);"><%= ann.title %></div>
                        <div><%= ann.content %></div>
                        <small style="opacity: 0.6;"><%= ann.date %></small>
                    </div>
                    <button onclick="dismissNotification('<%= ann.id %>', '<%= prof.id %>')" style="background:none; border:none; color:var(--accent);"><i class="fas fa-times"></i></button>
                </div>
            <% }) %>
        </div>
    <% } %>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-tasks"></i></div>
            <div><h3 id="todo-count">0</h3><p style="font-size: 0.7rem;">Ù…Ù‡Ø§Ù…</p></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: var(--success);"><i class="fas fa-check-double"></i></div>
            <div><h3 id="marked-sessions">0</h3><p style="font-size: 0.7rem;">Ø­ØµØµ Ù…Ø±ØµÙˆØ¯Ø©</p></div>
        </div>
        <div class="stat-card" style="grid-column: span 2; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; border-bottom: 4px solid #ffd700;">
            <div class="stat-icon" style="background: rgba(255,215,0,0.1); color: #ffd700;"><i class="fas fa-trophy"></i></div>
            <div style="flex: 1; display: flex; justify-content: space-between; align-items: center;">
                <div><h3 style="color: #ffd700;"><%= prof.stars_count || 0 %> <i class="fas fa-star" style="font-size: 0.9rem;"></i></h3><p style="font-size: 0.75rem;">Ø±ØµÙŠØ¯ Ø§Ù„ØªÙ…ÙŠØ²</p></div>
                <span style="font-size: 0.7rem; padding: 4px 12px; border-radius: 20px; background: rgba(255,255,255,0.1); color:#ffd700; border:1px solid #ffd700;">
                    <%= (prof.stars_count || 0) >= 100 ? 'Ù…Ø¹Ù„Ù… Ù‚Ø¯ÙŠØ±' : ((prof.stars_count || 0) >= 50 ? 'Ù…Ø¹Ù„Ù… Ù…ØªÙ…ÙŠØ²' : 'Ù…Ø¹Ù„Ù… Ù…Ø¨Ø§Ø¯Ø±') %>
                </span>
            </div>
        </div>
    </div>

   <section class="star-history-panel" style="margin-top: 20px;">
    <h3 onclick="toggleStarHistory()" style="font-size: 0.9rem; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; cursor: pointer; background: #f1f5f9; padding: 10px; border-radius: 12px;">
        <i class="fas fa-history"></i> 
        Ø³Ø¬Ù„ Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ù†Ø¬ÙˆÙ…
        <i id="history-chevron" class="fas fa-chevron-down" style="margin-right: auto; transition: 0.3s;"></i>
    </h3>

    <div id="star-history-content" style="background: white; border-radius: 15px; padding: 10px; box-shadow: var(--shadow); display: none; overflow: hidden;">
        <% if (typeof starHistory !== 'undefined' && starHistory.length > 0) { %>
            <% starHistory.forEach(log => { %>
                <div class="star-history-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px dashed #eee;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 30px; background: #fff9db; color: #fab005; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; font-weight: 700;"><%= log.reason %></div>
                            <small style="color: #94a3b8; font-size: 0.7rem;"><%= log.date %></small>
                        </div>
                    </div>
                    <span style="color: #40c057; font-weight: 900; font-size: 0.9rem;"><%= log.points %></span>
                </div>
            <% }) %>
        <% } else { %>
            <p style="text-align: center; color: #94a3b8; font-size: 0.8rem; padding: 10px;">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ù‡Ø§Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¬ÙˆÙ…!</p>
        <% } %>
    </div>
</section>

    <section id="section-schedule">
    <h3 style="margin-bottom: 10px; color: var(--primary); font-size: 1rem;">
        <i class="fas fa-calendar-day"></i> 
        Ø¬Ø¯ÙˆÙ„ Ø­ØµØµ ÙŠÙˆÙ…: <span id="current-day-name" style="color: var(--accent);"></span>
    </h3>
    <div class="banner-container">
        <div class="banner-scroll" id="banner-scroll">
            <% for(let i=1; i<=8; i++) { 
                let p = school_periods.find(x => x.id === i);
                
                // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­ØµØ© Ø§Ù„ØªÙŠ ØªØ·Ø§Ø¨Ù‚ Ø±Ù‚Ù… Ø§Ù„Ø­ØµØ© "Ùˆ" Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
                // Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ¹Ø±ÙŠÙ currentDayLocale ÙÙŠ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ø§Ù„Ø£Ø³ÙÙ„
            %>
                <div class="period-card" id="period-<%= i %>">
                    <span style="font-size: 0.7rem; font-weight: bold; color: #64748b;">Ø§Ù„Ø­ØµØ© <%= i %></span>
                    <div id="session-content-<%= i %>" style="font-size: 1.1rem; font-weight: 900; color: var(--primary); margin: 8px 0;">
                        <span style="opacity: 0.2;">--</span>
                    </div>
                    <span style="font-size: 0.7rem; color: #94a3b8;"><%= p ? p.start_time : '--:--' %></span>
                </div>
            <% } %>
        </div>
    </div>
</section>

    <section id="section-attendance" class="panel">
    <div id="no-session-msg" class="hidden" style="text-align: center; color: #94a3b8; padding: 30px;">
        <i class="fas fa-hourglass-start" style="font-size: 2.5rem; margin-bottom: 10px; opacity: 0.3;"></i>
        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØ© Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
    </div>

    <div id="attendance-already-marked" class="hidden" style="text-align: center; color: var(--success); padding: 30px; border: 2px dashed var(--success); border-radius: 15px;">
        <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 15px;"></i>
        <h3>ØªÙ… Ø±ØµØ¯ ØºÙŠØ§Ø¨ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø§Ù„ÙŠÙˆÙ…</h3>
        <p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø±ØµØ¯ Ø§Ù„ØºÙŠØ§Ø¨ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„ÙØµÙ„ ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ§Ø­Ø¯.</p>
    </div>

    <div id="attendance-active" class="hidden">
        <div style="background: #eff6ff; padding: 12px; border-radius: 12px; border-right: 5px solid var(--primary); margin-bottom: 15px; font-size: 0.9rem;">
            <strong> Ø±ØµØ¯ ØºÙŠØ§Ø¨ ÙØµÙ„: </strong> <span id="active-class-title">--</span>
        </div>
        <form action="/teacher/absences/mark" method="POST">
            <input type="hidden" name="enseignant_id" value="<%= prof.id %>">
            <input type="hidden" name="date" id="input-date">
            <input type="hidden" name="periode" id="input-p">
            <input type="hidden" name="classe" id="input-classe">
            <input type="hidden" name="section" id="input-section">
            
            <div class="student-grid" id="student-grid-container"></div>
            <button type="submit" class="btn-submit">ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨</button>
        </form>
    </div>
</section>

    <section id="section-todo" class="todo-section">
    <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 1rem;">
        <i class="fas fa-list-check"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø´Ø®ØµÙŠØ©
    </h3>
    <div style="display: flex; gap: 8px; margin-bottom: 15px;">
        <input type="text" id="todo-input" 
               style="padding: 12px; flex:1; border:2px solid #f1f5f9; border-radius:12px; outline:none; transition:0.3s;" 
               placeholder="Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙ†Ø¬Ø² Ø§Ù„ÙŠÙˆÙ…ØŸ"
               onkeypress="if(event.key === 'Enter') addTodo()">
        <button type="button" onclick="addTodo()" 
                style="background:var(--primary); color:white; border:none; width:45px; height:45px; border-radius:12px; cursor:pointer; font-size:1.2rem; transition:0.3s; display:flex; align-items:center; justify-content:center;">
            <i class="fas fa-plus"></i>
        </button>
    </div>
    <ul id="todo-list" style="list-style: none; padding: 0; font-size: 0.9rem;">
        </ul>
</section>
<script>

    // Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø³ÙƒØ±ÙŠØ¨Øª ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('input-date');
    if (dateInput) {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø¨ØªÙ†Ø³ÙŠÙ‚ YYYY-MM-DD
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
});
async function refreshAttendancePanel(classe, section, date) {
    const res = await fetch(`/teacher/absences/check-status?classe=${classe}&section=${section}&date=${date}`);
    const data = await res.json();

    if (data.alreadyMarked) {
        document.getElementById('attendance-active').classList.add('hidden');
        document.getElementById('no-session-msg').classList.add('hidden');
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙÙŠØ¯ Ø¨Ø£Ù† Ø§Ù„ØºÙŠØ§Ø¨ Ù…ÙƒØªÙ…Ù„
        let msgArea = document.getElementById('attendance-completed-msg');
        if(!msgArea) {
            msgArea = document.createElement('div');
            msgArea.id = 'attendance-completed-msg';
            msgArea.innerHTML = `<div style="text-align:center; padding:20px; color:#059669; background:#ecfdf5; border-radius:12px;">
                <i class="fas fa-check-double" style="font-size:2rem;"></i>
                <p>ØªÙ… Ø±ØµØ¯ Ø§Ù„ØºÙŠØ§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø§Ù„ÙŠÙˆÙ….</p>
            </div>`;
            document.getElementById('section-attendance').appendChild(msgArea);
        }
        msgArea.style.display = 'block';
    } else {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ
        document.getElementById('attendance-active').classList.remove('hidden');
        if(document.getElementById('attendance-completed-msg')) 
            document.getElementById('attendance-completed-msg').style.display = 'none';
    }
}
    

    // Ø¯Ø§Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
async function checkClassAttendance(classe, section) {
    const today = new Date().toISOString().split('T')[0];
    
    try {
        const response = await fetch(`/teacher/absences/check?classe=${classe}&section=${section}&date=${today}`);
        const data = await response.json();

        if (data.alreadyMarked) {
            // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø±ØµØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹: Ø£Ø®ÙÙ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ£Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
            document.getElementById('attendance-active').classList.add('hidden');
            document.getElementById('attendance-already-marked').classList.remove('hidden');
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±ØµØ¯: Ø£Ø¸Ù‡Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ
            document.getElementById('attendance-active').classList.remove('hidden');
            document.getElementById('attendance-already-marked').classList.add('hidden');
        }
    } catch (error) {
        console.error("Error checking attendance:", error);
    }
}
// 1. ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ù„ÙˆÙŠ
function updateTodoCounter() {
    const list = document.getElementById('todo-list'); // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…
    const counter = document.getElementById('todo-count'); // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
    
    if (list && counter) {
        counter.innerText = list.children.length; // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    }
}

// 2. ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„ØªØ´Ù…Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
function addTodo() {
    const input = document.getElementById('todo-input');
    const list = document.getElementById('todo-list');
    
    if (input.value.trim() === '') return;

    const li = document.createElement('li');
    li.style.cssText = "background:white; padding:10px 15px; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border:1px solid #f1f5f9;";
    
    li.innerHTML = `
        <span>${input.value}</span>
        <button onclick="removeTask(this)" style="background:none; border:none; color:#94a3b8; cursor:pointer;">
            <i class="fas fa-trash-alt"></i>
        </button>
    `;

    list.appendChild(li);
    input.value = '';
    
    updateTodoCounter(); // Ù†Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù… 0
}

// 3. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­Ø°Ù Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«
function removeTask(btn) {
    btn.parentElement.remove();
    updateTodoCounter(); // Ù†Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
}

// 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙˆØ± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ù…Ù‡Ø§Ù… Ù…Ø³Ø¨Ù‚Ø©)
document.addEventListener('DOMContentLoaded', updateTodoCounter);
</script>

    <section id="section-behavior" class="panel">
    <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 1rem;"><i class="fas fa-user-shield"></i> Ù…Ù„Ø§Ø­Ø¸Ø© Ø³Ù„ÙˆÙƒÙŠØ© Ø°ÙƒÙŠØ©</h3>
    
    <div style="display: flex; flex-direction: column; gap: 10px;">
        <div style="position: relative;">
            <input type="text" id="studentSearchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." 
                   style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--primary); font-family: 'Cairo'; outline: none;">
            
            <div id="searchResultsList" class="custom-search-results"></div>
        </div>

        <form action="/teacher/behavior/add" method="POST" id="behaviorForm">
            <input type="hidden" name="teacher_id" value="<%= prof.id %>">
            <input type="hidden" name="student_id" id="hiddenStudentId" required>
            
            <div id="selectedStudentBadge" style="display: none; margin-bottom: 10px; padding: 5px 10px; background: #e3f2fd; border-radius: 5px; color: #1976d2; font-size: 0.9rem;">
                ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: <span id="selectedStudentName" style="font-weight: bold;"></span>
                <i class="fas fa-times" style="margin-right: 10px; cursor: pointer; color: red;" onclick="clearStudentSelection()"></i>
            </div>

            <textarea name="event" placeholder="ØµÙ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø£Ùˆ Ø§Ù„Ø­Ø§Ø¯Ø«Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„..." required 
                      style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; height: 80px; font-family: 'Cairo'; margin-top: 5px;"></textarea>
            
            <button type="submit" class="btn-submit" style="width: 100%; padding: 12px; margin-top: 10px;">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </form>
    </div>
</section>
</div>

<nav class="bottom-nav">
    <a href="#top" class="nav-item active"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="#section-schedule" class="nav-item"><i class="fas fa-calendar-alt"></i>Ø§Ù„Ø¬Ø¯ÙˆÙ„</a>
    <a href="#section-attendance" class="nav-item"><i class="fas fa-user-check"></i>Ø§Ù„ØºÙŠØ§Ø¨</a>
    <a href="#section-todo" class="nav-item"><i class="fas fa-tasks"></i>Ø§Ù„Ù…Ù‡Ø§Ù…</a>
</nav>

<script>
    // 1. Initialisation des donnÃ©es
    const TIMETABLE = <%- JSON.stringify(timetable || []) %>;
    const PERIODS = <%- JSON.stringify(school_periods || []) %>;
    const ELEVES = <%- JSON.stringify(eleves || []) %>;
    const SUBSTITUTIONS = <%- JSON.stringify(substitute_logs || []) %>;
    const classLocks = <%- JSON.stringify(classLocks || []) %>;
    const dayNamesAr = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];

    const cleanAr = (str) => str ? str.trim().replace(/[Ø£Ø¥Ø¢]/g, 'Ø§') : "";

    // --- [FONCTION SUPPRESSION NOTIFICATION] ---
    function dismissNotification(annId, profId) {
        const element = document.getElementById('ann-box-' + annId);
        if (element) {
            element.style.opacity = '0';
            setTimeout(() => element.remove(), 300);
            
            // Sauvegarde locale pour ne plus l'afficher
            let dismissed = JSON.parse(localStorage.getItem('dismissed_ann_prof_' + profId) || '[]');
            if (!dismissed.includes(annId)) {
                dismissed.push(annId);
                localStorage.setItem('dismissed_ann_prof_' + profId, JSON.stringify(dismissed));
            }
        }
    }

    function updateApp() {
        try {
            const now = new Date();
            const currentDayNameAr = dayNamesAr[now.getDay()];
            const todayStr = '<%= typeof todayDate !== "undefined" ? todayDate : "" %>';

            if(document.getElementById('current-day-name')) 
                document.getElementById('current-day-name').textContent = currentDayNameAr;
            
            if(document.getElementById('live-clock')) 
                document.getElementById('live-clock').textContent = now.toLocaleTimeString('ar-EG', {hour12:false});

            const mins = now.getHours() * 60 + now.getMinutes();
            let activeP = null;

            PERIODS.forEach(p => {
                const card = document.getElementById(`period-${p.id}`);
                const sessionContent = document.getElementById(`session-content-${p.id}`); 
                if(!card || !sessionContent) return;

                const normal = TIMETABLE.find(x => Number(x.periode) === Number(p.id) && cleanAr(x.jour) === cleanAr(currentDayNameAr));
                const sub = SUBSTITUTIONS.find(x => Number(x.periode) === Number(p.id));

                if (sub) {
                    sessionContent.innerHTML = `<span class="sub-tag">Ø§Ø­ØªÙŠØ§Ø·</span> ${sub.classe}-${sub.section}`;
                } else if (normal) {
                    sessionContent.innerHTML = `${normal.classe}-${normal.section}`;
                } else {
                    sessionContent.innerHTML = '<span style="opacity:0.3">Ø§Ø³ØªØ±Ø§Ø­Ø©</span>';
                }

                const [hS, mS] = p.start_time.split(':').map(Number);
                const [hE, mE] = p.end_time.split(':').map(Number);
                const startMins = hS * 60 + mS;
                const endMins = hE * 60 + mE;

                if (mins >= startMins && mins < endMins) {
                    card.classList.add('active-now');
                    activeP = p;
                } else {
                    card.classList.remove('active-now');
                }
            });

            manageAttendanceUI(activeP, currentDayNameAr, todayStr);
        } catch (err) { console.error(err); }
    }

  function manageAttendanceUI(p, currentDayName, todayStr) {
        const noMsg = document.getElementById('no-session-msg');
        const activeArea = document.getElementById('attendance-active');
        const gridContainer = document.getElementById('student-grid-container');
        const submitBtn = document.querySelector('#attendance-active button[type="submit"]');

        if (!p) {
            if(noMsg) noMsg.classList.remove('hidden'); 
            if(activeArea) activeArea.classList.add('hidden');
            return;
        }

        const session = TIMETABLE.find(s => 
            Number(s.periode) === Number(p.id) && 
            cleanAr(s.jour) === cleanAr(currentDayName)
        ) || SUBSTITUTIONS.find(x => Number(x.periode) === Number(p.id));

        if (!session) {
            if(noMsg) noMsg.classList.remove('hidden'); 
            if(activeArea) activeArea.classList.add('hidden');
        } else {
            if(noMsg) noMsg.classList.add('hidden'); 
            if(activeArea) activeArea.classList.remove('hidden');
            
            document.getElementById('active-class-title').textContent = `${session.classe}-${session.section}`;
            document.getElementById('input-p').value = p.id;
            document.getElementById('input-date').value = todayStr;

            // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
            const serverLock = classLocks.find(l => 
                String(l.classe) === String(session.classe) && 
                String(l.section) === String(session.section) && 
                Number(l.periode) === Number(p.id)
            );

            // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† "Ù†Ø¬Ø§Ø­ Ø§Ù„Ø­ÙØ¸" Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ URL (Ø¨Ø¹Ø¯ Redirect Ù…Ø¨Ø§Ø´Ø±Ø©)
            const urlParams = new URLSearchParams(window.location.search);
            const justSaved = urlParams.get('success') === 'attendance_saved';

            if (serverLock || (justSaved && document.getElementById('input-p').value == p.id)) {
                gridContainer.innerHTML = `
                    <div class="lock-message" style="background: #f0fdf4; border: 2px solid #22c55e; padding: 25px; border-radius: 20px; text-align: center;">
                        <div style="background: #22c55e; color: white; width: 50px; height: 50px; line-height: 50px; border-radius: 50%; margin: 0 auto 15px; font-size: 1.5rem;">
                            <i class="fas fa-check"></i>
                        </div>
                        <h4 style="color: #15803d; font-weight: 800;">ØªÙ… Ø±ØµØ¯ Ø­Ø¶ÙˆØ± Ø§Ù„Ø­ØµØ©</h4>
                        <p style="color: #166534; font-size: 0.85rem; margin-top: 5px;">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ù†Ø¬ÙˆÙ…Ùƒ</p>
                    </div>`;
                if(submitBtn) submitBtn.style.display = 'none';
                gridContainer.dataset.currentClass = "LOCKED";
            } else {
                if(submitBtn) submitBtn.style.display = 'block';
                renderStudents(session.classe, session.section);
            }
        }
    }  
     function renderStudents(classe, section) {
    const container = document.getElementById('student-grid-container');
    
    // 1. Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ÙØ­Øµ: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‡ÙŠ Ø±Ø³Ø§Ù„Ø© "Ù†Ø¬Ø§Ø­ Ø§Ù„Ø±ØµØ¯"ØŒ ØªÙˆÙ‚Ù ÙÙˆØ±Ø§Ù‹ ÙˆÙ„Ø§ ØªÙ…Ø³Ø­Ù‡Ø§
    if (container.querySelector('.lock-message')) {
        return; 
    }

    // 2. Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø¹Ø±Ø¶ Ù†ÙØ³ Ø§Ù„ÙØµÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹ (Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡)
    if (container.dataset.currentClass === `${classe}-${section}`) return;

    // 3. Ø§Ù„Ø¢Ù† ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ù„Ù…Ø³Ø­ ÙˆØ§Ù„Ø±Ø³Ù… Ù„Ø£Ù†Ù†Ø§ ØªØ£ÙƒØ¯Ù†Ø§ Ø£Ù† Ø§Ù„ØµÙ ØºÙŠØ± Ù…Ù‚ÙÙ„
    container.innerHTML = ""; 
    container.dataset.currentClass = `${classe}-${section}`;

    const filteredStudents = ELEVES.filter(e => 
        String(e.classe) === String(classe) && 
        String(e.section) === String(section)
    );

    if (filteredStudents.length === 0) {
        container.innerHTML = "<p style='text-align:center; padding:20px; color:#94a3b8;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„</p>";
        return;
    }

    filteredStudents.forEach(el => {
        container.innerHTML += `
            <div class="student-card">
                <span>${el.nom}</span>
                <label class="switch">
                    <input type="checkbox" name="eleve_ids[]" value="${el.id}">
                    <span class="slider"></span>
                </label>
            </div>`;
    });
}
    // Initialisation au chargement
    window.onload = () => {
        updateApp();
        setInterval(updateApp, 5000);
        
        // Cacher les notifications dÃ©jÃ  supprimÃ©es
        const profId = '<%= prof.id %>';
        const dismissed = JSON.parse(localStorage.getItem('dismissed_ann_prof_' + profId) || '[]');
        dismissed.forEach(id => {
            const el = document.getElementById('ann-box-' + id);
            if (el) el.remove();
        });

       // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¹Ù„Ù… Ø¹Ø§Ø¦Ø¯Ø§Ù‹ Ù…Ù† Ø¹Ù…Ù„ÙŠØ© ØªÙ‚ÙŠÙŠÙ… Ù†Ø§Ø¬Ø­Ø©
const urlParams = new URLSearchParams(window.location.search);

if (urlParams.get('success') === 'evaluated') {
    
    // 1. ØªØ´ØºÙŠÙ„ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¬ÙˆÙ… (Ø§Ù„ÙƒÙˆÙ†ÙÙŠØªÙŠ)
    runConfetti();

    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´ÙƒØ± (Toast)
    showSuccessToast();

    // 3. Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£Ù‡Ù…: Ù…Ø³Ø­ Ø§Ù„Ù€ URL ÙÙˆØ±Ø§Ù‹ Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    // Ù‡Ø°Ø§ ÙŠÙ…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø¹Ù…Ù„ Refresh
    window.history.replaceState({}, document.title, window.location.pathname);
}

function runConfetti() {
    var duration = 3 * 1000;
    var end = Date.now() + duration;

    (function frame() {
      confetti({
        particleCount: 5,
        angle: 60,
        spread: 55,
        origin: { x: 0 },
        colors: ['#ffd700', '#1e3a8a']
      });
      confetti({
        particleCount: 5,
        angle: 120,
        spread: 55,
        origin: { x: 1 },
        colors: ['#ffd700', '#1e3a8a']
      });
      if (Date.now() < end) requestAnimationFrame(frame);
    }());
}

function showSuccessToast() {
    const toast = document.createElement('div');
    toast.className = 'success-toast-animation'; // Ø³Ù†Ø¶ÙŠÙ Ù„Ù‡Ø§ ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø³ÙŠØ·
    toast.innerHTML = `
        <div style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
                    background: #1e3a8a; color: white; padding: 15px 25px; 
                    border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
                    z-index: 9999; display: flex; align-items: center; gap: 10px;
                    border: 2px solid #ffd700; animation: slideDown 0.5s ease;">
            <i class="fas fa-star" style="color: #ffd700;"></i>
            <span>Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! ØªÙ… Ù…Ù†Ø­Ùƒ <strong>Ù†Ø¬Ù…Ø© Ø°Ù‡Ø¨ÙŠØ©</strong></span>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => { toast.remove(); }, 4000);
} 


    };

    function toggleStarHistory() {
    const content = document.getElementById('star-history-content');
    const chevron = document.getElementById('history-chevron');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.style.transform = 'rotate(180deg)'; // La flÃ¨che pointe vers le haut
        
        // Optionnel : Petit effet d'animation pour les items
        const items = content.querySelectorAll('.star-history-item');
        items.forEach((item, index) => {
            item.style.animation = `slideInRight 0.3s ease forwards ${index * 0.1}s`;
        });
    } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)'; // La flÃ¨che revient vers le bas
    }
}
</script>

<script>
    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ù„ÙˆÙƒÙŠ Ø§Ù„Ø°ÙƒÙŠ - ÙƒÙ…Ø§ Ù‡Ùˆ ---
    const studentsData = <%- JSON.stringify(eleves) %>;
    const searchInput = document.getElementById('studentSearchInput');
    const resultsList = document.getElementById('searchResultsList');
    const hiddenIdInput = document.getElementById('hiddenStudentId');
    const badge = document.getElementById('selectedStudentBadge');
    const badgeName = document.getElementById('selectedStudentName');

    if(searchInput) {
        searchInput.addEventListener('input', function() {
            const term = this.value.trim().toLowerCase();
            resultsList.innerHTML = '';
            if (term.length < 2) { resultsList.style.display = 'none'; return; }
            const matches = studentsData.filter(s => s.nom.toLowerCase().includes(term));
            if (matches.length > 0) {
                matches.forEach(s => {
                    const item = document.createElement('div');
                    item.className = 'search-item';
                    item.innerHTML = `<strong>${s.nom}</strong> <br> <span>Ø§Ù„ØµÙ: ${s.classe} - ${s.section}</span>`;
                    item.onclick = function() { selectStudent(s.id, s.nom); };
                    resultsList.appendChild(item);
                });
                resultsList.style.display = 'block';
            } else { resultsList.style.display = 'none'; }
        });
    }

    function selectStudent(id, name) {
        hiddenIdInput.value = id;
        badgeName.innerText = name;
        badge.style.display = 'block';
        searchInput.value = '';
        resultsList.style.display = 'none';
    }

    function clearStudentSelection() {
        hiddenIdInput.value = '';
        badge.style.display = 'none';
        searchInput.value = '';
    }

    document.addEventListener('click', function(e) {
        if (resultsList && e.target !== searchInput) resultsList.style.display = 'none';
    });
</script>
<div class="card secure-card" style="margin-top: 20px; padding: 0; border-radius: 15px; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden;">
    <div onclick="toggleSecureSection()" style="padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #fff;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-user-lock" style="color: #1e3a8a;"></i>
            <h3 style="color: #1e3a8a; margin: 0; font-size: 1.1rem;">ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
        </div>
        <i class="fas fa-chevron-down" id="secure-chevron" style="color: #94a3b8; transition: 0.3s;"></i>
    </div>

    <div id="secure-content" style="max-height: 0; overflow: hidden; transition: all 0.4s ease; padding: 0 20px;">
        <p style="font-size: 0.9rem; color: #64748b; margin-top: 0;">Ù‚Ù… Ø¨ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„ØªØ¹Ø²ÙŠØ² Ø£Ù…Ø§Ù† Ø­Ø³Ø§Ø¨Ùƒ.</p>
        
        <form action="/teacher/update-my-password" method="POST" class="secure-form-container" style="padding-bottom: 20px;">
            <div class="form-row">
                <div class="input-wrapper">
                    <i class="fas fa-key input-icon"></i>
                    <input 
                        type="password" 
                        name="new_password" 
                        id="teacher_secret_input" 
                        placeholder="Ø±Ù…Ø² Ø¯Ø®ÙˆÙ„ Ø¬Ø¯ÙŠØ¯..." 
                        required 
                        minlength="4"
                        autocomplete="new-password" 
                        class="custom-input"
                    >
                    <button type="button" class="toggle-view-btn" onclick="handleTeacherView()">
                        <i class="fas fa-eye" id="teacher_eye_icon"></i>
                    </button>
                </div>

                <button type="submit" class="submit-action-btn">
                    <span>Ø­ÙØ¸</span>
                    <i class="fas fa-save"></i>
                </button>
            </div>
            <div id="pass-strength" class="strength-meter"></div>
        </form>
    </div>
</div>

<style>
    /* Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¶ÙŠÙÙ‡ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª Ù„ÙØªØ­ Ø§Ù„Ù‚Ø³Ù… */
    .secure-open {
        max-height: 250px !important; /* Ù‚ÙŠÙ…Ø© ÙƒØ§ÙÙŠØ© Ù„Ù„Ù…Ø­ØªÙˆÙ‰ */
        padding-bottom: 10px !important;
    }
    
    .rotate-chevron {
        transform: rotate(180deg);
    }

    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ù†ÙØ³ Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø·ÙÙŠÙØ©) */
    .form-row { display: flex; gap: 8px; align-items: center; }
    .input-wrapper { position: relative; flex: 1; display: flex; align-items: center; }
    .input-icon { position: absolute; right: 12px; color: #94a3b8; z-index: 5; }
    .custom-input {
        width: 100%;
        padding: 12px 35px 12px 40px !important;
        border: 2px solid #f1f5f9;
        border-radius: 12px;
        background: #f8fafc;
        transition: 0.3s;
    }
    .custom-input:focus { border-color: #1e3a8a; outline: none; background: #fff; }
    .toggle-view-btn { position: absolute; left: 10px; background: none; border: none; color: #94a3b8; cursor: pointer; }
    .submit-action-btn {
        background: #1e3a8a; color: white; border: none; padding: 12px 20px;
        border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px;
    }
    .strength-meter { height: 4px; width: 0; background: #e2e8f0; margin-top: 8px; border-radius: 2px; transition: 0.3s; }
</style>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script>
// 1. ÙˆØ¸ÙŠÙØ© Ø§Ù„ÙØªØ­ ÙˆØ§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ø§Ù„Ø§Ù†Ø·ÙˆØ§Ø¡)
function toggleSecureSection() {
    const content = document.getElementById('secure-content');
    const chevron = document.getElementById('secure-chevron');
    
    content.classList.toggle('secure-open');
    chevron.classList.toggle('rotate-chevron');
}

// 2. ÙˆØ¸ÙŠÙØ© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø§Ù„Ø¹ÙŠÙ†)
function handleTeacherView() {
    const input = document.getElementById('teacher_secret_input');
    const icon = document.getElementById('teacher_eye_icon');
    
    if (input.type === "password") {
        input.type = "text";
        icon.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
        input.type = "password";
        icon.classList.replace('fa-eye-slash', 'fa-eye');
    }
}

// 3. Ù…Ø±Ø§Ù‚Ø¨ Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
document.getElementById('teacher_secret_input').addEventListener('input', function(e) {
    const meter = document.getElementById('pass-strength');
    const val = e.target.value;
    if(val.length === 0) meter.style.width = "0";
    else if(val.length < 4) { meter.style.width = "30%"; meter.style.background = "#ef4444"; }
    else if(val.length < 8) { meter.style.width = "60%"; meter.style.background = "#f59e0b"; }
    else { meter.style.width = "100%"; meter.style.background = "#22c55e"; }
});
</script>
</body>
</html>