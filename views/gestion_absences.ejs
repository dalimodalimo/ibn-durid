<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØºÙŠØ§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† - Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #fdfdfd; padding: 20px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #eee; }
        .absent-list { list-style: none; padding: 0; border-right: 4px solid #d32f2f; padding-right: 15px; }
        .btn-search { background: #1a237e; color: white; padding: 6px 12px; text-decoration: none; border-radius: 4px; font-size: 14px; transition: 0.3s; cursor: pointer; display: inline-block; border: none; }
        .btn-print { background: #2e7d32; color: white; padding: 6px 12px; text-decoration: none; border-radius: 4px; font-size: 14px; transition: 0.3s; display: inline-block; margin-right: 5px; }
        .btn-search:hover, .btn-print:hover { opacity: 0.9; transform: scale(1.02); }
        button { cursor: pointer; border: none; padding: 8px 20px; border-radius: 6px; font-weight: bold; }
        select, input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-left: 10px; outline: none; }
        .suggestion-box { margin-top: 15px; padding: 15px; background: #f0f4f8; border-radius: 8px; display: none; border: 1px solid #d1d9e6; }
        .loading-text { color: #1a237e; font-style: italic; font-size: 0.9rem; }
        .badge { background: #d32f2f; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }
        .actions { display: flex; gap: 8px; align-items: center; }
    </style>
</head>
<body>
    <a href="/admin/dashboard" style="text-decoration: none; color: #1a237e; font-weight: bold; display: inline-block; margin-bottom: 20px;">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
    
    <header style="border-bottom: 2px solid #1a237e; margin-bottom: 30px; padding-bottom: 10px;">
        <h1 style="margin: 0; color: #1a237e;">Ù†Ø¸Ø§Ù… ØºÙŠØ§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„Ø§Ø­ØªÙŠØ§Ø· Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…: <strong><%= today %></strong></p>
    </header>

    <div class="card">
        <h3>â• ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„Ù… ØºØ§Ø¦Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
        <form action="/admin/absences/ajouter" method="POST" style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
            <select name="enseignant_id" required style="flex: 1; min-width: 200px;">
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„ØºØ§Ø¦Ø¨ --</option>
                <% enseignants.forEach(e => { %> 
                    <option value="<%= e.id %>"><%= e.nom %> (<%= e.matiere %>)</option> 
                <% }) %>
            </select>
            <input type="text" name="raison" placeholder="Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨ (Ù…Ø«Ø§Ù„: Ø¸Ø±Ù Ø·Ø§Ø±Ø¦)" style="flex: 2; min-width: 250px;">
            <button type="submit" style="background:#d32f2f; color:white;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨</button>
        </form>
    </div>

    <div class="card">
        <h3>ğŸ“‹ Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ† Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ† Ø§Ù„ÙŠÙˆÙ… ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·</h3>
        <ul class="absent-list">
            <% if (ghaibeen.length === 0) { %>
                <p style="color: #7f8c8d; padding: 20px; text-align: center;">âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>
            <% } else { %>
                <% ghaibeen.forEach(g => { %>
                    <li style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="font-size: 1.1rem;"><%= g.nom %></strong> 
                                <span class="badge"><%= g.matiere %></span>
                                <% if(g.raison) { %> <br><small style="color: #666;">ğŸ“ Ø§Ù„Ø³Ø¨Ø¨: <%= g.raison %></small> <% } %>
                            </div>
                            <div class="actions">
                                <button onclick="getSuggestions('<%= g.enseignant_id %>', this)" class="btn-search">
                                    ğŸ” Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†
                                </button>
                                <a href="/admin/absences/print-reserve/<%= g.enseignant_id %>" class="btn-print">
                                    ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·
                                </a>
                            </div>
                        </div>

                        <div id="box-<%= g.enseignant_id %>" class="suggestion-box">
                            <h4 style="margin-top: 0; color: #2c3e50;">ğŸ’¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹:</h4>
                            <div class="loading-text" id="load-<%= g.enseignant_id %>" style="display:none;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©...</div>
                            <div id="results-<%= g.enseignant_id %>"></div>
                        </div>
                    </li>
                <% }) %>
            <% } %>
        </ul>
    </div>

    <script>
        async function getSuggestions(teacherId, btnElement) {
            const box = document.getElementById(`box-${teacherId}`);
            const resultsDiv = document.getElementById(`results-${teacherId}`);
            const loader = document.getElementById(`load-${teacherId}`);

            box.style.display = 'block';
            resultsDiv.innerHTML = '';
            loader.style.display = 'block';

            try {
                const response = await fetch(`/admin/absences/suggestions/${teacherId}`);
                const data = await response.json();

                loader.style.display = 'none';

                if (data.suggestions && data.suggestions.length > 0) {
                    let html = `<p style="font-size: 0.9rem;">Ù‡Ø¤Ù„Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ† Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡Ù… Ø­ØµØµ ÙÙŠ Ø§Ù„ÙØªØ±Ø§Øª: <b>${data.absent_periods.join(', ')}</b></p>`;
                    html += `<ul style="margin: 0; padding-right: 20px;">`;
                    data.suggestions.forEach(s => {
                        html += `<li style="margin-bottom: 5px;">âœ… <b>${s.nom}</b> (${s.matiere})</li>`;
                    });
                    html += `</ul>`;
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = `<p style="color: #d32f2f;">âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ù„Ù… Ù…ØªØ§Ø­ ØªÙ…Ø§Ù…Ø§Ù‹ ÙÙŠ Ø¬Ù…ÙŠØ¹ ÙØªØ±Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨.</p>`;
                }
            } catch (error) {
                loader.style.display = 'none';
                resultsDiv.innerHTML = `<p style="color: #d32f2f;">âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.</p>`;
            }
        }
    </script>
</body>
</html>