<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ - Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
    :root {
        --primary-blue: #0f172a;
        --accent-blue: #3b82f6;
        --danger-red: #ef4444;
        --bg-slate: #f1f5f9;
        --border-color: #e2e8f0;
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        --cell-height: calc((100vh - 170px) / 5.8);
    }

    body { 
        margin: 0; font-family: 'Cairo', sans-serif; 
        background-color: var(--bg-slate); color: var(--primary-blue);
        height: 100vh; overflow: hidden;
        display: flex; flex-direction: column;
    }

    /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±Ù‚Ù…ÙŠ (Ø§Ù„Ù…ØªØµÙØ­) --- */
    .top-navbar {
        background: var(--primary-blue); color: white;
        padding: 5px 20px; display: flex; flex-direction: column; gap: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); z-index: 1001;
    }
    .nav-main-row { display: flex; align-items: center; justify-content: space-between; gap: 15px; }
    .brand-section { display: flex; align-items: center; gap: 10px; min-width: 200px; }
    .brand-text h1 { font-size: 0.9rem; margin: 0; font-weight: 800; }
    .controls-section { display: flex; align-items: center; gap: 10px; flex: 1; justify-content: center; }
    .search-box { position: relative; width: 250px; }
    .nav-input, .nav-select {
        background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
        color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; outline: none;
    }
    .active-teacher-info {
        display: flex; align-items: center; gap: 10px;
        background: rgba(59, 130, 246, 0.15); padding: 3px 15px; border-radius: 20px;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }
    .info-value { font-size: 0.75rem; font-weight: 700; color: #60a5fa; }
    .btn-nav { padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; cursor: pointer; text-decoration: none; border: none; }
    .btn-primary { background: var(--accent-blue); color: white; }
    .btn-white { background: white; color: var(--primary-blue); }

    /* --- Ø¨Ù†Ùƒ Ø§Ù„Ø­ØµØµ --- */
    .bassin-wrapper { 
        background: white; padding: 4px 20px; border-bottom: 1px solid var(--border-color); 
        display: flex; align-items: center; gap: 10px; height: 50px;
    }
    .bassin-scroll { display: flex; gap: 8px; overflow-x: auto; flex: 1; align-items: center; }
    .class-mini-box { background: #f8fafc; border: 1px solid var(--border-color); border-radius: 6px; padding: 3px 8px; min-width: 120px; }
    .drag-card { background: var(--accent-blue); color: white; padding: 2px 6px; border-radius: 4px; cursor: grab; font-size: 0.65rem; font-weight: 700; display: block; margin-top: 2px; text-align: center; }

    /* --- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
    .main-grid-container { flex: 1; padding: 5px 10px; overflow: hidden; }
    .smart-table { width: 100%; height: 100%; border-collapse: separate; border-spacing: 2px; table-layout: fixed; }
    .smart-table th { background: var(--primary-blue); color: white; padding: 4px; border-radius: 4px; font-size: 0.75rem; }
    .drop-zone { height: var(--cell-height); background: #fff; border: 1.5px dashed #cbd5e1; border-radius: 6px; position: relative; }
    .session-item { background: white; border: 1px solid #cbd5e1; border-right: 3px solid var(--accent-blue); border-radius: 6px; height: 90%; display: flex; align-items: center; justify-content: center; position: relative; font-size: 0.75rem; }
    .btn-del { position: absolute; top: -3px; left: -3px; background: var(--danger-red); color: white; border: none; border-radius: 50%; width: 15px; height: 15px; font-size: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

    /* =========================================
       ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø·ÙˆØ± (Ù„Ø¬Ø¯ÙˆÙ„ÙŠÙ† ÙÙŠ ØµÙØ­Ø© A4)
       ========================================= */
    #print-header { display: none; }

    @media print {
        @page { size: A4 portrait; margin: 0.5cm; }
        
        body { background: white; height: auto; overflow: visible; display: block; }
        .top-navbar, .bassin-wrapper, .btn-del, .modal-overlay, .btn-group, .btn-nav { display: none !important; }

        #print-header { 
            display: flex !important; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 10px;
        }
        .print-school-info h3 { margin: 0; font-size: 1rem; }
        .print-school-info p { margin: 1px 0; font-size: 0.7rem; }
        .print-title h2 { margin: 0; font-size: 1.1rem; color: #000; }
        .print-title p { margin: 0; font-size: 0.8rem; font-weight: bold; }
        
        .main-grid-container { 
            padding: 0; 
            height: 42vh; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„ÙŠØ³Ù…Ø­ Ø¨Ø¬Ø¯ÙˆÙ„ Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© */
            min-height: 42vh;
            overflow: visible; 
            page-break-inside: avoid;
        }
        .smart-table { 
            border: 2px solid #000 !important; 
            border-collapse: collapse !important; 
            height: 100%; 
            table-layout: fixed;
        }
        .smart-table th, .smart-table td { 
            border: 1px solid #000 !important; 
            padding: 4px !important; 
            color: #000 !important;
            background: none !important;
            text-align: center !important;
            font-size: 0.85rem !important;
        }
        .smart-table th { font-weight: bold; background-color: #f2f2f2 !important; -webkit-print-color-adjust: exact; }
        .session-item { 
            border: none !important; 
            font-weight: bold; 
            font-size: 0.9rem !important; 
            background: none !important;
        }
    }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 3000; }
    .modal-card { background: white; width: 300px; border-radius: 12px; padding: 20px; text-align: center; }
    #suggestions-list { position: absolute; background: white; width: 100%; top: 35px; z-index: 2000; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: none; }
    .suggest-item { padding: 8px 12px; cursor: pointer; color: var(--primary-blue); font-size: 0.8rem; border-bottom: 1px solid #eee; }
</style>
</head>
<body>

<div id="print-header">
    <div class="print-school-info">
        <h3>Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯ Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</h3>
        <p>Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù† - ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…</p>
    </div>
    <div class="print-title">
        <h2>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h2>
        <p id="print-teacher-details" style="font-weight: bold; margin-top: 5px;">Ø§Ù„Ø§Ø³Ù…: ........ | Ø§Ù„Ù…Ø§Ø¯Ø©: ........</p>
    </div>
    <div class="print-logo" style="text-align: left;">
        <i class="fas fa-school fa-2x"></i>
        <p style="font-size: 0.6rem; margin: 0;">2024 / 2025 Ù…</p>
    </div>
</div>

<header class="top-navbar">
    <div class="nav-main-row">
        <div class="brand-section">
            <i class="fas fa-calendar-check" style="font-size: 1.2rem; color: var(--accent-blue);"></i>
            <div class="brand-text"><h1>Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯</h1></div>
        </div>
        <div class="controls-section">
            <div class="search-box">
                <input type="text" id="teacher-search" class="nav-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ù„Ù…..." oninput="searchTeachers(this.value)">
                <div id="suggestions-list"></div>
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <label style="font-size: 0.65rem; opacity: 0.8;">Ø­ØµØµ/ÙØµÙ„:</label>
                <select id="sessions-per-class" class="nav-select" onchange="refreshBassin()">
                    <% for(let i=1; i<=10; i++) { %>
                        <option value="<%= i %>" <%= i==2 ? 'selected' : '' %>><%= i %></option>
                    <% } %>
                </select>
            </div>
        </div>
        <div class="btn-group">
            <a href="/admin/dashboard" class="btn-nav btn-primary"><i class="fas fa-home"></i></a>
            <button onclick="window.print()" class="btn-nav btn-white"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
        </div>
    </div>

    <div class="active-teacher-info" id="teacher-badge" style="visibility: hidden;">
        <div class="info-item"><span class="info-label">Ø§Ù„Ù…Ø¹Ù„Ù…</span><span class="info-value" id="display-name">-</span></div>
        <div style="width: 1px; height: 15px; background: rgba(255,255,255,0.2);"></div>
        <div class="info-item"><span class="info-label">Ø§Ù„Ù…Ø§Ø¯Ø©</span><span class="info-value" id="display-subject">-</span></div>
    </div>
</header>

<div class="bassin-wrapper">
    <div style="font-size:0.65rem; font-weight:800; color:#64748b; white-space:nowrap;">ğŸ“¦ Ø¨Ù†Ùƒ Ø§Ù„Ø­ØµØµ:</div>
    <div id="drag-source-area" class="bassin-scroll">
        <span style="color:#94a3b8; font-size:0.65rem;">Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹ Ù„Ù„Ø¨Ø¯Ø¡...</span>
    </div>
</div>

<div class="main-grid-container">
    <table class="smart-table">
        <thead>
            <tr>
                <th style="width: 60px;">Ø§Ù„ÙŠÙˆÙ…</th>
                <% for(let i=1; i<=8; i++) { %> <th><%= i %></th> <% } %>
            </tr>
        </thead>
        <tbody id="grid-body">
            <% const jours = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³']; %>
            <% jours.forEach(j => { %>
                <tr>
                    <td style="font-weight: 800; background: #f1f5f9; text-align: center; border-radius: 4px; font-size: 0.7rem;"><%= j %></td>
                    <% for(let p=1; p<=8; p++) { %>
                        <td class="drop-zone" data-day="<%= j %>" data-period="<%= p %>" ondrop="handleDrop(event)" ondragover="allowDrop(event)" ondragleave="clearDropEffect(event)"></td>
                    <% } %>
                </tr>
            <% }) %>
        </tbody>
    </table>
</div>

<div class="modal-overlay" id="deleteModal">
    <div class="modal-card">
        <h4 style="margin:0 0 10px 0;">Ø­Ø°Ù Ø§Ù„Ø­ØµØ©ØŸ</h4>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-nav btn-primary" style="flex:1; background:var(--danger-red)" id="confirmBtn">Ø­Ø°Ù</button>
            <button class="btn-nav btn-white" style="flex:1; border:1px solid #ddd" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<script>
    const enseignants = <%- JSON.stringify(enseignants) %>;
    const allAffectations = <%- JSON.stringify(all_affectations) %>;
    let fullSchedule = <%- JSON.stringify(schedule) %>;
    let currentTeacher = null;
    let pendingDeleteId = null;

    function searchTeachers(val) {
        const list = document.getElementById('suggestions-list');
        list.innerHTML = '';
        if (!val) { list.style.display = 'none'; return; }
        const matches = enseignants.filter(t => t.nom.toLowerCase().includes(val.toLowerCase()));
        matches.forEach(t => {
            const div = document.createElement('div');
            div.className = 'suggest-item';
            div.innerText = t.nom;
            div.onclick = () => selectTeacher(t);
            list.appendChild(div);
        });
        list.style.display = matches.length ? 'block' : 'none';
    }

    function selectTeacher(t) {
        currentTeacher = t;
        document.getElementById('teacher-search').value = t.nom;
        document.getElementById('suggestions-list').style.display = 'none';
        document.getElementById('teacher-badge').style.visibility = 'visible';
        document.getElementById('display-name').innerText = t.nom;
        document.getElementById('display-subject').innerText = t.matiere || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        document.getElementById('print-teacher-details').innerText = `Ø§Ù„Ù…Ø¹Ù„Ù…: ${t.nom} | Ø§Ù„Ù…Ø§Ø¯Ø©: ${t.matiere || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
        refreshBassin();
        renderGrid();
    }

    function refreshBassin() {
        if (!currentTeacher) return;
        const area = document.getElementById('drag-source-area');
        area.innerHTML = '';
        const qty = parseInt(document.getElementById('sessions-per-class').value);
        const assignments = allAffectations.filter(a => a.enseignant_id == currentTeacher.id);
        
        assignments.forEach(a => {
            const placed = fullSchedule.filter(s => s.enseignant_id == currentTeacher.id && s.classe == a.classe && s.section == a.section).length;
            const remaining = qty - placed;
            const box = document.createElement('div');
            box.className = 'class-mini-box';
            box.innerHTML = `<div style="font-size:0.65rem; font-weight:800;">${a.classe}-${a.section}</div>
                ${remaining > 0 ? `<div class="drag-card" draggable="true" ondragstart="handleDragStart(event, ${JSON.stringify(a).replace(/"/g, '&quot;')})">Ø³Ø­Ø¨ (${remaining})</div>` : '<div style="color:green; font-size:0.6rem;">âœ…</div>'}`;
            area.appendChild(box);
        });
    }

    function handleDragStart(e, data) { e.dataTransfer.setData("application/json", JSON.stringify(data)); }
    function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('over'); }
    function clearDropEffect(e) { e.currentTarget.classList.remove('over'); }

    async function handleDrop(e) {
        e.preventDefault(); e.currentTarget.classList.remove('over');
        if (!currentTeacher) return;
        const data = JSON.parse(e.dataTransfer.getData("application/json"));
        const payload = { 
            enseignant_id: currentTeacher.id, 
            class_info: `${data.classe}|${data.section}`, 
            jour: e.currentTarget.dataset.day, 
            periode: e.currentTarget.dataset.period 
        };

        const res = await fetch('/admin/timetable/ajouter-json', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(payload) 
        });
        
        const result = await res.json();
        if (result.success) {
            fullSchedule.push({ 
                id: result.id, 
                enseignant_id: currentTeacher.id, 
                classe: data.classe, 
                section: data.section, 
                jour: payload.jour, 
                periode: payload.periode 
            });
            renderGrid();
            refreshBassin();
        }
    }

    function askDelete(id) { pendingDeleteId = id; document.getElementById('deleteModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('deleteModal').style.display = 'none'; pendingDeleteId = null; }

    document.getElementById('confirmBtn').onclick = async function() {
        if (!pendingDeleteId) return;
        const res = await fetch(`/admin/timetable/supprimer-json/${pendingDeleteId}`, { method: 'DELETE' });
        if ((await res.json()).success) {
            fullSchedule = fullSchedule.filter(s => s.id != pendingDeleteId);
            renderGrid();
            refreshBassin();
        }
        closeModal();
    };

    function renderGrid() {
        document.querySelectorAll('.drop-zone').forEach(z => z.innerHTML = '');
        fullSchedule.filter(s => s.enseignant_id == currentTeacher?.id).forEach(s => {
            const zone = document.querySelector(`.drop-zone[data-day="${s.jour}"][data-period="${s.periode}"]`);
            if (zone) zone.innerHTML = `<div class="session-item">
                                            <button class="btn-del" onclick="askDelete(${s.id})">&times;</button>
                                            <div style="font-weight:800;">${s.classe}-${s.section}</div>
                                        </div>`;
        });
    }
</script>

</body>
</html>