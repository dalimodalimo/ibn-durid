<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ - Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary: #0f172a;
            --accent: #3b82f6;
            --bg: #f1f5f9;
            --card: #ffffff;
            --border: #e2e8f0;
            --text-muted: #64748b;
            --cell-height: calc((100vh - 200px) / 6);
        }

        body { 
            font-family: 'Cairo', sans-serif; background: var(--bg); 
            margin: 0; padding: 0; color: #1e293b; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        .header-nav {
            background: var(--primary); color: white;
            padding: 8px 20px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 1000;
        }

        .brand { display: flex; align-items: center; gap: 10px; }
        .brand h1 { font-size: 0.95rem; margin: 0; font-weight: 800; color: white; }

        .mode-selector {
            display: flex; background: rgba(255,255,255,0.1); padding: 4px; border-radius: 8px; gap: 4px;
        }
        .mode-btn {
            padding: 6px 15px; border-radius: 6px; border: none; font-size: 0.75rem;
            cursor: pointer; color: white; background: transparent; transition: 0.3s; font-weight: 700;
        }
        .mode-btn.active { background: var(--accent); }

        .toggle-container {
            display: flex; align-items: center; gap: 10px;
            background: rgba(255,255,255,0.1); padding: 5px 15px;
            border-radius: 20px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2);
            transition: 0.3s;
        }
        .toggle-container.active { background: #10b981; border-color: #059669; }
        .toggle-label { font-size: 0.7rem; font-weight: 800; color: white; pointer-events: none; }
        .toggle-switch {
            width: 30px; height: 16px; background: #64748b; border-radius: 15px;
            position: relative; transition: 0.3s;
        }
        .toggle-switch::before {
            content: ''; position: absolute; width: 12px; height: 12px;
            background: white; border-radius: 50%; top: 2px; right: 2px; transition: 0.3s;
        }
        .active .toggle-switch { background: white; }
        .active .toggle-switch::before { right: 16px; background: #10b981; }

        .search-wrapper { position: relative; width: 220px; }
        .search-input {
            width: 100%; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
            color: white !important; padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; outline: none;
        }

        #suggestions-list {
            position: absolute; top: 110%; left: 0; right: 0; background: white;
            border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 2000; 
            border: 1px solid var(--border); display: none; overflow: hidden;
        }
        .suggest-item { padding: 10px 15px; cursor: pointer; font-size: 0.85rem; color: var(--primary) !important; border-bottom: 1px solid #f1f5f9; text-align: right; }

        .bassin-section { 
            background: var(--card); 
            border-bottom: 1px solid var(--border); 
            padding: 10px 20px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            height: 60px; 
            position: relative; 
            overflow: hidden;
        }

        .bassin-background-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.2rem;
            font-weight: 900;
            color: #0f172a; /* Ù„ÙˆÙ† ØºØ§Ù…Ù‚ */
            opacity: 0.05; /* ÙŠØ¨Ø¯Ø£ Ø¨Ø§Ù‡Øª Ø¬Ø¯Ø§Ù‹ */
            white-space: nowrap;
            pointer-events: none;
            z-index: 0;
            display: none;
            transition: opacity 0.5s ease, font-size 0.5s ease;
        }

        .bassin-scroll { 
            display: flex; 
            gap: 10px; 
            overflow-x: auto; 
            flex: 1; 
            position: relative; 
            z-index: 1; 
            align-items: center;
        }

        .chip-item {
            background:#f8fafc; 
            border:1px solid #e2e8f0; 
            padding:4px 10px; 
            border-radius:8px; 
            min-width:90px; 
            text-align:center; 
            z-index:2;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: ØªØµØºÙŠØ± ÙˆØ¥Ø²Ø§Ø­Ø© */
        .chip-completed {
            opacity: 0.5;
            transform: scale(0.8);
            filter: grayscale(0.8);
            order: 2; /* Ù„ØªØµØ·Ù ÙÙŠ Ø¬Ù‡Ø© Ø§Ù„ÙŠÙ…ÙŠÙ† */
        }

        .grid-container { flex: 1; padding: 10px; overflow: hidden; }
        .timetable-grid { width: 100%; height: 100%; border-collapse: separate; border-spacing: 4px; table-layout: fixed; }
        .timetable-grid th { background: var(--primary); color: white; border-radius: 6px; font-size: 0.75rem; padding: 6px; }
        .day-column { background: #e2e8f0; font-weight: 800; font-size: 0.75rem; text-align: center; border-radius: 6px; width: 70px; }
        
        .drop-zone { background: white; border-radius: 8px; height: var(--cell-height); position: relative; }
        .drop-zone.over { border: 2px dashed var(--accent); background: #eff6ff; }

        .session-card {
            background: white; border: 1px solid var(--border); border-right: 4px solid var(--accent);
            border-radius: 6px; height: 92%; margin: 2%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-size: 0.7rem; position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center;
        }

        .session-ghost { opacity: 0.3; background: #6b87a4; border-right: 4px solid #94a3b8; filter: grayscale(1); pointer-events: none; }

        .delete-btn { position: absolute; top: -5px; left: -5px; width: 16px; height: 16px; background: #ef4444; color: white; border: none; border-radius: 50%; font-size: 9px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        @media print {
            body { overflow: visible; height: auto; background: white; }
            .header-nav, .bassin-section, .delete-btn, .toggle-container { display: none !important; }
            .timetable-grid { border: 2px solid #000; height: auto; }
            .timetable-grid th, .timetable-grid td { border: 1px solid #000 !important; color: black !important; }
            .session-ghost { display: none !important; }
        }
    </style>
</head>
<body>

<header class="header-nav">
    <div class="brand"><h1>Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯</h1></div>

    <div class="mode-selector">
        <button id="btn-teach" class="mode-btn active" onclick="switchMode('teacher')">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…</button>
        <button id="btn-class" class="mode-btn" onclick="switchMode('class')">Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙÙˆÙ</button>
    </div>

    <div id="toggle-ghosts" class="toggle-container" onclick="toggleGhosts()">
        <span class="toggle-label">ØªØ®Ø·ÙŠØ· Ø§Ù„ÙØµÙˆÙ„</span>
        <div class="toggle-switch"></div>
    </div>

    <div class="search-wrapper">
        <input type="text" id="main-search" class="search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø«..." autocomplete="off" oninput="handleSearch(this.value)">
        <div id="suggestions-list"></div>
    </div>

    <div style="display:flex; gap:8px;">
        <select id="sessions-count" class="search-input" style="width:120px; color: white;" onchange="refreshBassin()">
            <option value="1">Ø­ØµØ© ÙˆØ§Ø­Ø¯Ø©</option>
            <option value="2" selected>Ø­ØµØªØ§Ù†</option>
            <option value="3">Ù£ Ø­ØµØµ</option>
            <option value="4">Ù¤ Ø­ØµØµ</option>
            <option value="5">Ù¥ Ø­ØµØµ</option>
            <option value="6">Ù¦ Ø­ØµØµ</option>
            <option value="7">Ù§ Ø­ØµØµ</option>
            <option value="8">Ù¨ Ø­ØµØµ</option>
            <option value="9">Ù© Ø­ØµØµ</option>
            <option value="10">Ù¡Ù  Ø­ØµØµ</option>
        </select>
        <button onclick="window.print()" class="search-input" style="cursor:pointer; background:white; color:var(--primary) !important; width:auto; font-weight:bold;">Ø·Ø¨Ø§Ø¹Ø©</button>
        <a href="/admin/dashboard" class="search-input" style="background:var(--accent); text-decoration:none; width:auto; display:flex; align-items:center; justify-content:center;"><i class="fas fa-home"></i></a>
    </div>
</header>

<div id="bassin-area" class="bassin-section">
    <div id="bassin-bg-text" class="bassin-background-info"></div>
    <div id="drag-source-area" class="bassin-scroll"></div>
</div>

<div class="grid-container">
    <table class="timetable-grid">
        <thead>
            <tr><th width="70">Ø§Ù„ÙŠÙˆÙ…</th><% for(let i=1; i<=8; i++) { %> <th><%= i %></th> <% } %></tr>
        </thead>
        <tbody id="grid-body">
            <% const jours = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³']; %>
            <% jours.forEach(j => { %>
                <tr>
                    <td class="day-column"><%= j %></td>
                    <% for(let p=1; p<=8; p++) { %>
                        <td class="drop-zone" data-day="<%= j %>" data-period="<%= p %>" ondrop="handleDrop(event)" ondragover="allowDrop(event)" ondragleave="clearDropEffect(event)"></td>
                    <% } %>
                </tr>
            <% }) %>
        </tbody>
    </table>
</div>

<script>
    const enseignants = <%- JSON.stringify(enseignants) %>;
    const allAffectations = <%- JSON.stringify(all_affectations) %>;
    let fullSchedule = []; 
    let currentMode = 'teacher'; 
    let selectedItem = null;
    let showGhosts = false; 

    const classesList = [...new Set(allAffectations.map(a => `${a.classe}-${a.section}`))].sort();

    async function loadFullData() {
        try {
            const response = await fetch('/admin/timetable/data');
            const data = await response.json();
            fullSchedule = data.schedule || [];
            renderGrid();
        } catch (error) { console.error("Ø®Ø·Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error); }
    }

    window.onload = loadFullData;

    function toast(title, icon = 'success') {
        Swal.fire({
            title: title, icon: icon, toast: true, position: 'top-end',
            showConfirmButton: false, timer: 3000, timerProgressBar: true
        });
    }

    function toggleGhosts() {
        if (currentMode !== 'teacher') return;
        showGhosts = !showGhosts;
        document.getElementById('toggle-ghosts').classList.toggle('active');
        renderGrid();
    }

    function switchMode(mode) {
        currentMode = mode;
        selectedItem = null;
        document.getElementById('main-search').value = '';
        document.getElementById('bassin-bg-text').style.display = 'none';
        document.getElementById('btn-teach').classList.toggle('active', mode === 'teacher');
        document.getElementById('btn-class').classList.toggle('active', mode === 'class');
        document.getElementById('bassin-area').style.display = mode === 'teacher' ? 'flex' : 'none';
        document.getElementById('toggle-ghosts').style.opacity = mode === 'teacher' ? '1' : '0.3';
        renderGrid();
    }

    function handleSearch(val) {
        const list = document.getElementById('suggestions-list');
        list.innerHTML = '';
        if (!val) { list.style.display = 'none'; return; }
        let matches = (currentMode === 'teacher') 
            ? enseignants.filter(t => t.nom.includes(val)).map(t => ({ id: t.id, name: t.nom, data: t }))
            : classesList.filter(c => c.includes(val)).map(c => ({ id: c, name: c, data: c }));

        matches.forEach(m => {
            const div = document.createElement('div');
            div.className = 'suggest-item';
            div.innerText = m.name;
            div.onclick = () => {
                selectedItem = m.data;
                document.getElementById('main-search').value = m.name;
                list.style.display = 'none';
                if (currentMode === 'teacher') refreshBassin();
                renderGrid();
            };
            list.appendChild(div);
        });
        list.style.display = matches.length ? 'block' : 'none';
    }

    function renderGrid() {
        document.querySelectorAll('.drop-zone').forEach(z => z.innerHTML = '');
        if (!selectedItem) return;

        if (currentMode === 'teacher' && showGhosts) {
            const teacherClasses = allAffectations
                .filter(a => String(a.enseignant_id) === String(selectedItem.id))
                .map(a => `${a.classe}-${a.section}`);

            fullSchedule.forEach(s => {
                const sessionClass = `${s.classe}-${s.section}`;
                if (teacherClasses.includes(sessionClass) && String(s.enseignant_id) !== String(selectedItem.id)) {
                    const zone = document.querySelector(`.drop-zone[data-day="${s.jour}"][data-period="${s.periode}"]`);
                    if (zone) {
                        zone.innerHTML = `<div class="session-card session-ghost"><b>${sessionClass}</b><i>${s.matiere || ''}</i></div>`;
                    }
                }
            });
        }

        let mainSessions = (currentMode === 'teacher') 
            ? fullSchedule.filter(s => String(s.enseignant_id) === String(selectedItem.id)) 
            : fullSchedule.filter(s => `${s.classe}-${s.section}` === selectedItem);

        mainSessions.forEach(s => {
            const zone = document.querySelector(`.drop-zone[data-day="${s.jour}"][data-period="${s.periode}"]`);
            if (zone) {
                const title = currentMode === 'teacher' ? `${s.classe}-${s.section}` : (s.matiere || 'Ù…Ø§Ø¯Ø©');
                const subtitle = currentMode === 'teacher' ? '' : (s.prof_nom || '');
                zone.innerHTML = `<div class="session-card" style="z-index: 5; background: white;">
                    ${currentMode === 'teacher' ? `<button class="delete-btn" onclick="deleteSession(${s.id})">&times;</button>` : ''}
                    <b>${title}</b>${subtitle ? `<i style="font-size:0.6rem; font-style:normal; color:#64748b;">${subtitle}</i>` : ''}
                </div>`;
            }
        });
    }

    function refreshBassin() {
        if (!selectedItem || currentMode !== 'teacher') {
            document.getElementById('bassin-bg-text').style.display = 'none';
            return;
        }

        const area = document.getElementById('drag-source-area');
        const bgText = document.getElementById('bassin-bg-text');
        
        bgText.innerText = `${selectedItem.nom} - ${selectedItem.matiere || ''}`;
        bgText.style.display = 'block';

        area.innerHTML = '';
        const qty = parseInt(document.getElementById('sessions-count').value);
        const assigns = allAffectations.filter(a => String(a.enseignant_id) === String(selectedItem.id));
        
        let completedClasses = 0;

        assigns.forEach(a => {
            const placed = fullSchedule.filter(s => String(s.enseignant_id) === String(selectedItem.id) && s.classe == a.classe && s.section == a.section).length;
            const remaining = qty - placed;
            const isDone = remaining <= 0;
            
            if(isDone) completedClasses++;

            const chip = document.createElement('div');
            // Ø¥Ø¹Ø·Ø§Ø¡ order: 2 Ù„Ù„Ù…ÙƒØªÙ…Ù„ Ùˆ order: 1 Ù„ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„ Ù„ØªØ±ØªÙŠØ¨Ù‡Ù… Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±
            chip.className = `chip-item ${isDone ? 'chip-completed' : ''}`;
            chip.style.order = isDone ? "2" : "1";
            
            chip.innerHTML = `<span style="font-size:0.7rem; font-weight:800; color:#1e293b;">${a.classe}-${a.section}</span>
                ${!isDone 
                    ? `<div style="background:var(--accent); color:white; border-radius:4px; font-size:0.65rem; font-weight:700; cursor:grab; margin-top:3px; padding:2px 0;" draggable="true" ondragstart="handleDragStart(event, ${JSON.stringify(a).replace(/"/g, '&quot;')})">Ø³Ø­Ø¨ (${remaining})</div>` 
                    : '<div style="color:#10b981; font-size:0.8rem; margin-top:3px;">âœ…</div>'}`;
            area.appendChild(chip);
        });

        // Ø²ÙŠØ§Ø¯Ø© ÙˆØ¶ÙˆØ­ Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ù„ÙÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø¯Ù…
        const progress = assigns.length > 0 ? (completedClasses / assigns.length) : 0;
        bgText.style.opacity = 0.05 + (progress * 0.45); // ØªØ²Ø¯Ø§Ø¯ Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ù„ØªØµÙ„ Ø¥Ù„Ù‰ 0.5 ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
        bgText.style.fontSize = (2.2 + (progress * 0.3)) + "rem"; // ÙŠÙƒØ¨Ø± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
    }

    function handleDragStart(e, data) { e.dataTransfer.setData("application/json", JSON.stringify(data)); }
    function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('over'); }
    function clearDropEffect(e) { e.currentTarget.classList.remove('over'); }

    async function handleDrop(e) {
        e.preventDefault(); e.currentTarget.classList.remove('over');
        if (currentMode !== 'teacher' || !selectedItem) return;
        const data = JSON.parse(e.dataTransfer.getData("application/json"));
        const payload = { enseignant_id: selectedItem.id, class_info: `${data.classe}|${data.section}`, jour: e.currentTarget.dataset.day, periode: e.currentTarget.dataset.period };
        
        try {
            const res = await fetch('/admin/timetable/ajouter-json', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const result = await res.json();
            if (result.success) {
                fullSchedule.push({ 
                    id: result.id, 
                    enseignant_id: selectedItem.id, 
                    classe: data.classe, 
                    section: data.section, 
                    jour: payload.jour, 
                    periode: payload.periode, 
                    matiere: selectedItem.matiere, 
                    prof_nom: selectedItem.nom 
                });
                renderGrid(); 
                refreshBassin();
                toast("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­ØµØ© Ø¨Ù†Ø¬Ø§Ø­");
            } else { toast(result.message, 'error'); }
        } catch(err) { toast("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±", 'error'); }
    }

    async function deleteSession(id) {
        if (!id || id === 'undefined') {
            toast("Ø®Ø·Ø£: Ø§Ù„Ù…Ø¹Ø±Ù ØºÙŠØ± ØµØ§Ù„Ø­ØŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©", "error");
            return;
        }

        try {
            const res = await fetch(`/admin/timetable/supprimer-json/${id}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.success) {
                fullSchedule = fullSchedule.filter(s => s.id != id);
                renderGrid(); 
                refreshBassin();
                toast("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­ØµØ© Ø¨Ù†Ø¬Ø§Ø­");
            } else {
                toast(result.message || "ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù", "error");
            }
        } catch(err) { toast("âŒ ÙØ´Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù", 'error'); }
    }

    document.addEventListener('click', (e) => {
        if (!document.getElementById('main-search').contains(e.target)) document.getElementById('suggestions-list').style.display = 'none';
    });
</script>

</body>
</html>