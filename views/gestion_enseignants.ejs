<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= titre %></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/settings_style.css">
    <link rel="stylesheet" href="/css/enseignants_style.css">
    <style>
        :root {
            --sidebar-width: 260px;
            --primary-blue: #1a237e;
            --stat-card-1: #4f46e5;
            --stat-card-2: #06b6d4;
            --stat-card-3: #8b5cf6;
            --success-green: #10b981;
        }

        body {
            display: flex; min-height: 100vh; overflow-x: hidden;
            background-color: #f4f7fe; margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Sidebar System */
        .sidebar {
            width: var(--sidebar-width); transition: 0.3s; right: 0;
            position: fixed; height: 100vh; z-index: 1000;
            background: var(--primary-blue); color: white;
        }
        .sidebar.collapsed { right: calc(var(--sidebar-width) * -1); }
        .main {
            flex: 1; margin-right: var(--sidebar-width); transition: 0.3s;
            width: 100%; padding: 20px; padding-top: 70px;
        }
        .main.expanded { margin-right: 0; }
        .sidebar-toggle {
            position: fixed; top: 15px; right: 15px; z-index: 1100;
            background: var(--primary-blue); color: white; border: none;
            width: 40px; height: 40px; border-radius: 8px; cursor: pointer;
        }

        /* Stats Section */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: white; padding: 20px; border-radius: 15px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-right: 5px solid;
        }
        .card-1 { border-right-color: var(--stat-card-1); }
        .card-2 { border-right-color: var(--stat-card-2); }
        .card-3 { border-right-color: var(--stat-card-3); }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; }

        /* Assignment Banner */
        .assignment-banner {
            margin-top: 20px; background: #ffffff; border: 2px dashed var(--stat-card-2);
            border-radius: 15px; padding: 20px; animation: slideInUp 0.4s ease;
        }
        .banner-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #edf2f7; padding-bottom: 10px; }
        .queued-classes { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .queue-card {
            background: #f0f9ff; border: 1px solid #bae6fd; padding: 8px 15px;
            border-radius: 10px; display: flex; align-items: center; gap: 12px;
        }
        .btn-remove-queue { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem; }

        /* Table Tags */
        .tags-container { display: flex; flex-wrap: wrap; gap: 5px; }
        .tag-classe {
            background: #e0f2fe; color: #0369a1; padding: 4px 8px; border-radius: 6px;
            font-size: 0.8rem; display: flex; align-items: center; gap: 5px; border: 1px solid #bae6fd;
        }
        .btn-remove-tag { background: none; border: none; color: #ef4444; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }

        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { .sidebar { right: calc(var(--sidebar-width) * -1); } .sidebar.active { right: 0; } .main { margin-right: 0; } }
    </style>
</head>
<body>

<button class="sidebar-toggle" id="toggleSidebar"><i class="fas fa-bars"></i></button>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><h2><i class="fas fa-chalkboard-teacher"></i> شؤون المعلمين</h2></div>
    <div class="sidebar-nav">
        <a href="/admin/dashboard"><i class="fas fa-home"></i> العودة للرئيسية</a>
        <a href="#section-add-teacher"><i class="fas fa-user-plus"></i> إضافة معلم</a>
        <a href="#section-assign"><i class="fas fa-link"></i> إسناد الفصول</a>
        <a href="#section-table"><i class="fas fa-table"></i> سجل المعلمين</a>
    </div>
</div>

<div class="main" id="mainContent">
    <header class="page-header"><h1>إدارة الكادر التعليمي</h1></header>

    <div class="stats-grid">
        <div class="stat-card card-1">
            <div class="stat-info"><h4>إجمالي المعلمين</h4><h2><%= enseignants.length %></h2></div>
            <div class="stat-icon" style="background: var(--stat-card-1)"><i class="fas fa-users"></i></div>
        </div>
        <div class="stat-card card-2">
            <div class="stat-info"><h4>الفصول المسندة</h4><h2><%= affectations.length %></h2></div>
            <div class="stat-icon" style="background: var(--stat-card-2)"><i class="fas fa-school"></i></div>
        </div>
        <div class="stat-card card-3">
            <div class="stat-info"><h4>المواد الدراسية</h4><h2><%= subjects.length %></h2></div>
            <div class="stat-icon" style="background: var(--stat-card-3)"><i class="fas fa-book"></i></div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
        <section class="card" id="section-add-teacher">
            <h3><i class="fas fa-user-plus"></i> إضافة معلم جديد</h3>
            <form action="/admin/enseignants/ajouter" method="POST" class="form-grid">
                <div class="input-group">
                    <label>اسم المعلم الكامل</label>
                    <input type="text" name="nom" required placeholder="مثال: أحمد محمد">
                </div>
                <div class="input-group">
                    <label>المادة التخصصية</label>
                    <select name="matiere" required>
                        <option value="" disabled selected>اختر المادة...</option>
                        <% subjects.forEach(sub => { %><option value="<%= sub.name %>"><%= sub.name %></option><% }) %>
                    </select>
                </div>
                <div class="input-group">
                    <label>رقم التواصل</label>
                    <input type="text" name="phone">
                </div>
                <button type="submit" class="btn btn-save" style="margin-top: 20px; width: 100%;">حفظ المعلم</button>
            </form>
        </section>

        <section class="card" id="section-assign">
            <h3><i class="fas fa-link"></i> إسناد الفصول</h3>
            <div class="form-grid">
                <div class="input-group">
                    <label>اختيار المعلم</label>
                    <select id="profSelector">
                        <option value="" disabled selected>اختر معلماً...</option>
                        <% enseignants.forEach(prof => { %><option value="<%= prof.id %>"><%= prof.nom %></option><% }) %>
                    </select>
                </div>
                <div class="input-group">
                    <label>الصف والشعبة</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="classSelector" style="flex: 1;">
                            <% classes.forEach(c => { %>
                                <% for(let i=1; i <= c.num_sections; i++) { %>
                                    <option value="<%= c.class_name %>|<%= i %>">صف <%= c.class_name %> - <%= i %></option>
                                <% } %>
                            <% }) %>
                        </select>
                        <button type="button" class="btn" onclick="addToQueue()" style="background: var(--stat-card-2); color: white;"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>

            <div id="assignmentBanner" class="assignment-banner hidden">
                <div class="banner-header">
                    <span>الفصول المحددة: <b id="classCount">0</b></span>
                    <i class="fas fa-layer-group" style="color: var(--stat-card-2);"></i>
                </div>
                <div class="queued-classes" id="queuedClasses"></div>
                <form action="/admin/enseignants/affecter-multiple" method="POST">
                    <input type="hidden" name="enseignant_id" id="finalProfId">
                    <input type="hidden" name="classes_data" id="finalClassesData">
                    <button type="submit" class="btn btn-save" style="width: 100%; background: var(--success-green);">إعتماد الإسناد</button>
                </form>
            </div>
        </section>
    </div>

    <section class="card" id="section-table" style="margin-top: 20px;">
        <h3><i class="fas fa-list-ul"></i> سجل المعلمين والفصول المسندة</h3>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>المعلم</th>
                        <th>التخصص</th>
                        <th>الهاتف</th>
                        <th style="width: 40%;">الفصول الحالية</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    <% enseignants.forEach(prof => { %>
                    <tr>
                        <td><b><%= prof.nom %></b></td>
                        <td><span class="badge-matiere"><%= prof.matiere %></span></td>
                        <td><code><%= prof.phone_number || '---' %></code></td>
                        <td>
                            <div class="tags-container">
                                <% 
                                   let profAff = affectations.filter(a => a.enseignant_id === prof.id);
                                   if(profAff.length > 0) {
                                       profAff.forEach(aff => { %>
                                            <div class="tag-classe">
                                                <%= aff.classe %> / <%= aff.section %>
                                                <form action="/admin/enseignants/desaffecter" method="POST" style="display:inline;">
                                                    <input type="hidden" name="id" value="<%= aff.id %>">
                                                    <button type="submit" class="btn-remove-tag" title="إزالة">&times;</button>
                                                </form>
                                            </div>
                                       <% }) 
                                   } else { %>
                                       <small style="color: #ccc;">لا توجد فصول</small>
                                   <% } %>
                            </div>
                        </td>
                        <td>
                            <a href="/admin/enseignants/supprimer/<%= prof.id %>" class="btn btn-danger" onclick="return confirm('حذف المعلم نهائياً؟')">حذف</a>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </section>
</div>

<script>
    // Sidebar Toggle
    const toggleBtn = document.getElementById('toggleSidebar');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    toggleBtn.addEventListener('click', () => {
        if (window.innerWidth <= 768) sidebar.classList.toggle('active');
        else { sidebar.classList.toggle('collapsed'); mainContent.classList.toggle('expanded'); }
    });

    // Queue System
    let queue = [];
    function addToQueue() {
        const profId = document.getElementById('profSelector').value;
        const classSelect = document.getElementById('classSelector');
        const classVal = classSelect.value;
        const classText = classSelect.options[classSelect.selectedIndex].text;

        if (!profId) return alert("يرجى اختيار معلم أولاً");
        if (queue.find(item => item.value === classVal)) return alert("الفصل مضاف مسبقاً");

        queue.push({ value: classVal, text: classText });
        renderQueue();
    }

    function removeFromQueue(val) {
        queue = queue.filter(item => item.value !== val);
        renderQueue();
    }

    function renderQueue() {
        const banner = document.getElementById('assignmentBanner');
        const container = document.getElementById('queuedClasses');
        const countLabel = document.getElementById('classCount');
        const profId = document.getElementById('profSelector').value;

        if (queue.length === 0) { banner.classList.add('hidden'); return; }
        banner.classList.remove('hidden');
        countLabel.innerText = queue.length;
        container.innerHTML = '';
        queue.forEach(item => {
            container.innerHTML += `
                <div class="queue-card">
                    <span>${item.text}</span>
                    <button type="button" class="btn-remove-queue" onclick="removeFromQueue('${item.value}')">&times;</button>
                </div>`;
        });
        document.getElementById('finalProfId').value = profId;
        document.getElementById('finalClassesData').value = JSON.stringify(queue.map(i => i.value));
    }

    document.getElementById('profSelector').addEventListener('change', () => { queue = []; renderQueue(); });
</script>
</body>
</html>