<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ - Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† Ø¯Ø±ÙŠØ¯</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; padding: 20px; }
        .section { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; }
        th, td { border: 1px solid #aaa; padding: 10px; text-align: center; font-size: 14px; }
        th { background: #1a237e; color: white; }
        .filter-container { display: flex; gap: 20px; margin-bottom: 15px; background: #e3f2fd; padding: 15px; border-radius: 8px; align-items: center; }
        .btn-add { background: #2e7d32; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-add:hover { background: #1b5e20; }
        select, input { padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        .cell-info { font-size: 0.85rem; color: #555; line-height: 1.4; }
    </style>
</head>
<body>
    <a href="/admin/dashboard" style="text-decoration:none; color: #1a237e; font-weight: bold;">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
    <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ</h1>

    <div class="filter-container">
        <form action="/admin/timetable" method="GET" style="display:flex; align-items:center; gap:10px;">
            <label>Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…: </label>
            <select name="teacher_filter" onchange="this.form.submit()">
                <option value="">-- ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† --</option>
                <% enseignants.forEach(p => { %>
                    <option value="<%= p.id %>" <%= teacher_filter == p.id ? 'selected' : '' %>><%= p.nom %></option>
                <% }) %>
            </select>
            
            <label style="margin-right:20px;">Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„ØµÙ: </label>
            <select name="class_filter" onchange="this.form.submit()">
                <option value="">-- ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ --</option>
                <% unique_classes.forEach(c => { %>
                    <% let val = c.classe + "-" + c.section; %>
                    <option value="<%= val %>" <%= class_filter == val ? 'selected' : '' %>>Ø§Ù„ØµÙ <%= c.classe %> / <%= c.section %></option>
                <% }) %>
            </select>
            <a href="/admin/timetable" style="margin-right:15px; font-size: 0.8rem; color: #d32f2f;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ±</a>
        </form>
    </div>

    <div class="section">
        <h3>â• Ø¥Ø¶Ø§ÙØ© Ø­ØµØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <form action="/admin/timetable/ajouter" method="POST" style="display:flex; gap:10px; flex-wrap:wrap; align-items: flex-end;">
            <div>
                <label style="display:block; margin-bottom:5px;">Ø§Ù„Ù…Ø¹Ù„Ù…</label>
                <select name="enseignant_id" id="teacher_select" required onchange="filterClasses()">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù„Ù…...</option>
                    <% enseignants.forEach(p => { %> <option value="<%= p.id %>"><%= p.nom %></option> <% }) %>
                </select>
            </div>

            <div>
                <label style="display:block; margin-bottom:5px;">Ø§Ù„ØµÙ Ø§Ù„Ù…Ø³Ù†Ø¯</label>
                <select name="class_info" id="class_select" required disabled>
                    <option value="">Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
                </select>
            </div>

            <div>
                <label style="display:block; margin-bottom:5px;">Ø§Ù„ÙŠÙˆÙ…</label>
                <select name="jour" required>
                    <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
                    <option value="Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†">Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</option>
                    <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
                    <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
                    <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
                </select>
            </div>

            <div>
                <label style="display:block; margin-bottom:5px;">Ø§Ù„Ø­ØµØ©</label>
                <select name="periode" required>
                    <% for(let i=1; i<=8; i++) { %> <option value="<%= i %>">Ø§Ù„Ø­ØµØ© <%= i %></option> <% } %>
                </select>
            </div>

            <button type="submit" class="btn-add">Ø­ÙØ¸ Ø§Ù„Ø­ØµØ©</button>
        </form>
    </div>

    <div class="section">
        <h2 style="text-align:center; color: #1a237e;">
            <% if(teacher_filter) { %> 
                Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…: <%= enseignants.find(e => e.id == teacher_filter).nom %> 
            <% } else if(class_filter) { %> 
                Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙ: <%= class_filter.replace('-',' / ') %> 
            <% } else { %> 
                Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…Ø¯Ø±Ø³Ø© 
            <% } %>
        </h2>
        <table>
            <thead>
                <tr>
                    <th style="width: 100px;">Ø§Ù„ÙŠÙˆÙ…</th>
                    <% for(let i=1; i<=8; i++) { %> <th>Ø§Ù„Ø­ØµØ© <%= i %></th> <% } %>
                </tr>
            </thead>
            <tbody>
                <% const jours = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³']; %>
                <% jours.forEach(j => { %>
                    <tr>
                        <td style="background:#eee; font-weight:bold;"><%= j %></td>
                        <% for(let p=1; p<=8; p++) { %>
                            <td>
                                <% let cell = schedule.find(s => s.jour === j && s.periode === p); %>
                                <% if(cell) { %>
                                    <div class="cell-info">
                                        <strong><%= cell.matiere %></strong><br>
                                        <span><%= cell.prof_nom %></span><br>
                                        <small>(<%= cell.classe %>/<%= cell.section %>)</small>
                                    </div>
                                <% } %>
                            </td>
                        <% } %>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>

    <script>
        // Ø¬Ù„Ø¨ Ø§Ù„ØªÙƒÙ„ÙŠÙØ§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
        const allAffectations = <%- JSON.stringify(all_affectations) %>;

        function filterClasses() {
            const teacherId = document.getElementById('teacher_select').value;
            const classSelect = document.getElementById('class_select');
            
            classSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ...</option>';
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø³Ù†Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙƒÙ„ÙŠÙØ§Øª (affectations)
            const filtered = allAffectations.filter(a => a.enseignant_id == teacherId);
            
            if(filtered.length > 0) {
                classSelect.disabled = false;
                filtered.forEach(a => {
                    let opt = document.createElement('option');
                    opt.value = a.classe + "|" + a.section;
                    opt.text = "ØµÙ " + a.classe + " / Ø´Ø¹Ø¨Ø© " + a.section;
                    classSelect.add(opt);
                });
            } else {
                classSelect.disabled = true;
                classSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ Ù…Ø³Ù†Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù…</option>';
            }
        }
    </script>
</body>
</html>