<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= titre %></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/settings_style.css">
    <link rel="stylesheet" href="/css/enseignants_style.css">
    <style>
        :root {
            --sidebar-width: 260px;
            --primary-blue: #1a237e;
            --stat-card-1: #4f46e5;
            --stat-card-2: #06b6d4;
            --stat-card-3: #8b5cf6;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --danger-red: #ef4444;
        }

        body {
            display: flex; min-height: 100vh; overflow-x: hidden;
            background-color: #f4f7fe; margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Sidebar System */
        .sidebar {
            width: var(--sidebar-width); transition: 0.3s; right: 0;
            position: fixed; height: 100vh; z-index: 1000;
            background: var(--primary-blue); color: white;
        }
        .sidebar.collapsed { right: calc(var(--sidebar-width) * -1); }
        .main {
            flex: 1; margin-right: var(--sidebar-width); transition: 0.3s;
            width: 100%; padding: 20px; padding-top: 70px;
        }
        .main.expanded { margin-right: 0; }
        .sidebar-toggle {
            position: fixed; top: 15px; right: 15px; z-index: 1100;
            background: var(--primary-blue); color: white; border: none;
            width: 40px; height: 40px; border-radius: 8px; cursor: pointer;
        }

        /* Stats Section */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: white; padding: 20px; border-radius: 15px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-right: 5px solid;
        }
        .card-1 { border-right-color: var(--stat-card-1); }
        .card-2 { border-right-color: var(--stat-card-2); }
        .card-3 { border-right-color: var(--stat-card-3); }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; }

        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; left: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: white; min-width: 300px; padding: 16px 20px; border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 12px;
            border-right: 6px solid; animation: slideInLeft 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transition: 0.3s;
        }
        .toast.success { border-right-color: var(--success-green); color: #065f46; }
        .toast.error { border-right-color: var(--danger-red); color: #991b1b; }
        .toast.info { border-right-color: var(--stat-card-2); color: #0c4a6e; }

        /* Table UI */
        .tags-container { display: flex; flex-wrap: wrap; gap: 5px; }
        .tag-classe {
            background: #e0f2fe; color: #0369a1; padding: 4px 8px; border-radius: 6px;
            font-size: 0.8rem; display: flex; align-items: center; gap: 5px; border: 1px solid #bae6fd;
        }
        .btn-remove-tag { background: none; border: none; color: #ef4444; cursor: pointer; font-weight: bold; }
        
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000; transition: 0.3s;
        }
        .hidden { display: none !important; }

        @keyframes slideInLeft { from { transform: translateX(-120%); } to { transform: translateX(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { .sidebar { right: calc(var(--sidebar-width) * -1); } .sidebar.active { right: 0; } .main { margin-right: 0; } }
    </style>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>

<button class="sidebar-toggle" id="toggleSidebar"><i class="fas fa-bars"></i></button>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><h2><i class="fas fa-chalkboard-teacher"></i> شؤون المعلمين</h2></div>
    <div class="sidebar-nav">
        <a href="/admin/dashboard"><i class="fas fa-home"></i> العودة للرئيسية</a>
        <a href="#section-add-teacher"><i class="fas fa-user-plus"></i> إضافة معلم</a>
        <a href="#section-assign"><i class="fas fa-link"></i> إسناد الفصول</a>
        <a href="#section-table"><i class="fas fa-table"></i> سجل المعلمين</a>
    </div>
</div>

<div class="main" id="mainContent">
    <header class="page-header"><h1>إدارة الكادر التعليمي</h1></header>

    <div class="stats-grid">
        <div class="stat-card card-1">
            <div class="stat-info"><h4>إجمالي المعلمين</h4><h2><%= enseignants.length %></h2></div>
            <div class="stat-icon" style="background: var(--stat-card-1)"><i class="fas fa-users"></i></div>
        </div>
        <div class="stat-card card-2">
            <div class="stat-info"><h4>الفصول المسندة</h4><h2><%= affectations.length %></h2></div>
            <div class="stat-icon" style="background: var(--stat-card-2)"><i class="fas fa-school"></i></div>
        </div>
        <div class="stat-card card-3">
            <div class="stat-info"><h4>المواد الدراسية</h4><h2><%= subjects.length %></h2></div>
            <div class="stat-icon" style="background: var(--stat-card-3)"><i class="fas fa-book"></i></div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
        <section class="card" id="section-add-teacher">
            <h3><i class="fas fa-user-plus"></i> إضافة معلم جديد</h3>
            <form action="/admin/enseignants/ajouter" method="POST" class="form-grid">
                <div class="input-group">
                    <label>اسم المعلم الكامل</label>
                    <input type="text" name="nom" required placeholder="مثال: أحمد محمد">
                </div>
                <div class="input-group">
                    <label>المادة التخصصية</label>
                    <select name="matiere" required>
                        <option value="" disabled selected>اختر المادة...</option>
                        <% subjects.forEach(sub => { %><option value="<%= sub.name %>"><%= sub.name %></option><% }) %>
                    </select>
                </div>
                <div class="input-group">
                    <label>رقم التواصل</label>
                    <input type="text" name="phone">
                </div>
                <button type="submit" class="btn btn-save" style="margin-top: 20px; width: 100%;">حفظ المعلم</button>
            </form>
        </section>

        <section class="card" id="section-assign">
            <h3><i class="fas fa-link"></i> إسناد الفصول</h3>
            <div class="form-grid">
                <div class="input-group">
                    <label>اختيار المعلم</label>
                    <select id="profSelector">
                        <option value="" disabled selected>اختر معلماً...</option>
                        <% enseignants.forEach(prof => { %><option value="<%= prof.id %>"><%= prof.nom %></option><% }) %>
                    </select>
                </div>
                <div class="input-group">
                    <label>الصف والشعبة</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="classSelector" style="flex: 1;">
                            <% classes.forEach(c => { %>
                                <% for(let i=1; i <= c.num_sections; i++) { %>
                                    <option value="<%= c.class_name %>|<%= i %>">صف <%= c.class_name %> - <%= i %></option>
                                <% } %>
                            <% }) %>
                        </select>
                        <button type="button" class="btn" onclick="addToQueue()" style="background: var(--stat-card-2); color: white;"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>

            <div id="assignmentBanner" class="assignment-banner hidden">
                <div class="banner-header">
                    <span>الفصول المحددة: <b id="classCount">0</b></span>
                    <i class="fas fa-layer-group" style="color: var(--stat-card-2);"></i>
                </div>
                <div class="queued-classes" id="queuedClasses"></div>
                <form action="/admin/enseignants/affecter-multiple" method="POST">
                    <input type="hidden" name="enseignant_id" id="finalProfId">
                    <input type="hidden" name="classes_data" id="finalClassesData">
                    <button type="submit" class="btn btn-save" style="width: 100%; background: var(--success-green);">إعتماد الإسناد</button>
                </form>
            </div>
        </section>
    </div>

    <div class="card" style="margin: 20px 0; padding: 15px;">
        <div style="display: flex; gap: 15px; align-items: center;">
            <i class="fas fa-search" style="color: var(--primary-blue);"></i>
            <input type="text" id="teacherSearch" placeholder="بحث سريع باسم المعلم أو المادة..." 
                   style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
        </div>
    </div>

    <section class="card" id="section-table">
        <h3><i class="fas fa-list-ul"></i> سجل المعلمين والفصول المسندة</h3>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>المعلم</th>
                        <th>التخصص</th>
                        <th>الهاتف</th>
                        <th style="width: 35%;">الفصول الحالية</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    <% enseignants.forEach(prof => { %>
                    <tr class="teacher-row">
                        <td><b><%= prof.nom %></b></td>
                        <td><span class="badge-matiere" style="background: #f1f5f9; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem;"><%= prof.matiere %></span></td>
                        <td><code><%= prof.phone_number || '---' %></code></td>
                        <td>
                            <div class="tags-container">
                                <% let profAff = affectations.filter(a => a.enseignant_id === prof.id);
                                   if(profAff.length > 0) {
                                       profAff.forEach(aff => { %>
                                            <div class="tag-classe">
                                                <%= aff.classe %> / <%= aff.section %>
                                                <form action="/admin/enseignants/desaffecter" method="POST" style="display:inline;">
                                                    <input type="hidden" name="id" value="<%= aff.id %>">
                                                    <button type="submit" class="btn-remove-tag" title="إزالة">&times;</button>
                                                </form>
                                            </div>
                                       <% }) 
                                   } else { %>
                                       <small style="color: #ccc;">لا توجد فصول</small>
                                   <% } %>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="btn" style="background: var(--warning-orange); color: white; border:none; border-radius: 6px; padding: 6px 12px; cursor:pointer;"
                                        onclick="openEditModal('<%= prof.id %>', '<%= prof.nom %>', '<%= prof.matiere %>', '<%= prof.phone_number %>')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <a href="/admin/enseignants/supprimer/<%= prof.id %>" class="btn btn-danger" 
                                   style="background: var(--danger-red); color: white; padding: 6px 12px; border-radius: 6px; text-decoration: none;"
                                   onclick="return confirm('حذف المعلم نهائياً؟')">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </section>
</div>

<div id="editModal" class="modal-overlay hidden">
    <div class="card" style="width: 400px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">تعديل بيانات المعلم</h3>
        <form action="/admin/enseignants/modifier" method="POST">
            <input type="hidden" name="id" id="edit_id">
            <div class="input-group">
                <label>الاسم الكامل</label>
                <input type="text" name="nom" id="edit_nom" required>
            </div>
            <div class="input-group" style="margin-top: 15px;">
                <label>المادة</label>
                <select name="matiere" id="edit_matiere">
                    <% subjects.forEach(sub => { %><option value="<%= sub.name %>"><%= sub.name %></option><% }) %>
                </select>
            </div>
            <div class="input-group" style="margin-top: 15px;">
                <label>الهاتف</label>
                <input type="text" name="phone_number" id="edit_phone">
            </div>
            <div style="margin-top: 25px; display: flex; gap: 10px;">
                <button type="submit" class="btn btn-save" style="flex: 1;">حفظ التغييرات</button>
                <button type="button" onclick="closeEditModal()" class="btn" style="background: #999; flex: 1; border:none; color:white; border-radius:6px; cursor:pointer;">إلغاء</button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- Toast System ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let icon = 'fa-check-circle';
        if(type === 'error') icon = 'fa-exclamation-triangle';
        if(type === 'info') icon = 'fa-info-circle';

        toast.innerHTML = `
            <i class="fas ${icon}"></i>
            <span>${message}</span>
        `;
        container.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(-20px)';
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }

    // Handle URL Parameters for feedback
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('success')) {
        const msg = urlParams.get('success');
        if(msg === 'updated') showToast("تم تحديث بيانات المعلم بنجاح");
        else if(msg === 'assigned') showToast("تم إسناد الفصول بنجاح");
        else if(msg === 'deassigned') showToast("تم إلغاء إسناد الفصل");
        else showToast("تمت العملية بنجاح");
    } 
    if (urlParams.has('error')) {
        const errorType = urlParams.get('error');
        if(errorType === 'conflict') {
            const name = urlParams.get('name');
            const sub = urlParams.get('subject');
            showToast(`تضارب: الأستاذ ${name} يدرس مادة ${sub} لهذا الفصل بالفعل`, 'error');
        } else {
            showToast("حدث خطأ أثناء تنفيذ العملية", "error");
        }
    }

    // --- Sidebar Toggle ---
    const toggleBtn = document.getElementById('toggleSidebar');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    toggleBtn.addEventListener('click', () => {
        if (window.innerWidth <= 768) sidebar.classList.toggle('active');
        else { sidebar.classList.toggle('collapsed'); mainContent.classList.toggle('expanded'); }
    });

    // --- Queue System for Assignments ---
    let queue = [];
    function addToQueue() {
        const profId = document.getElementById('profSelector').value;
        const classSelect = document.getElementById('classSelector');
        const classVal = classSelect.value;
        const classText = classSelect.options[classSelect.selectedIndex].text;

        if (!profId) {
            showToast("يرجى اختيار معلم أولاً", "info");
            return;
        }
        if (queue.find(item => item.value === classVal)) {
            showToast("هذا الفصل مضاف بالفعل للقائمة", "info");
            return;
        }

        queue.push({ value: classVal, text: classText });
        renderQueue();
    }

    function removeFromQueue(val) {
        queue = queue.filter(item => item.value !== val);
        renderQueue();
    }

    function renderQueue() {
        const banner = document.getElementById('assignmentBanner');
        const container = document.getElementById('queuedClasses');
        const countLabel = document.getElementById('classCount');
        const profId = document.getElementById('profSelector').value;

        if (queue.length === 0) { banner.classList.add('hidden'); return; }
        banner.classList.remove('hidden');
        countLabel.innerText = queue.length;
        container.innerHTML = '';
        queue.forEach(item => {
            container.innerHTML += `
                <div class="queue-card">
                    <span>${item.text}</span>
                    <button type="button" class="btn-remove-queue" onclick="removeFromQueue('${item.value}')">&times;</button>
                </div>`;
        });
        document.getElementById('finalProfId').value = profId;
        document.getElementById('finalClassesData').value = JSON.stringify(queue.map(i => i.value));
    }

    document.getElementById('profSelector').addEventListener('change', () => { 
        if(queue.length > 0) {
            queue = []; 
            renderQueue();
            showToast("تم تغيير المعلم، يرجى إعادة تحديد الفصول", "info");
        }
    });

    // --- Search Filter ---
    document.getElementById('teacherSearch').addEventListener('input', function(e) {
        const term = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('.teacher-row');
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(term) ? "" : "none";
        });
    });

    // --- Modal Management ---
    function openEditModal(id, nom, matiere, phone) {
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_nom').value = nom;
        document.getElementById('edit_matiere').value = matiere;
        document.getElementById('edit_phone').value = phone;
        document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }
</script>
</body>
</html>